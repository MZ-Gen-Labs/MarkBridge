# PaddleOCR統合 開発サマリー

## 1. 目的
MarkBridge内で**PaddleOCR**（具体的にはPP-Structure V3エンジン）を統合し、日本語文書および表構造の高精度な認識とマークダウン変換を実現する。

## 2. 選定の経緯・要件
既存のエンジン（Docling/EasyOCR）との比較において、以下の理由から**PaddleOCR**を選定しました。

1.  **ライセンス要件**:
    *   商用利用可能な **Apache 2.0 Licnese** であることが必須条件でした。
    *   （比較対象のSuryaはGPL v3のため採用不可）
2.  **機能要件（表・レイアウト認識）**:
    *   単なるテキスト抽出（OCR）だけでなく、ドキュメントの構造解析（Layout Analysis）に強いことが求められました。
    *   PaddleOCRの **PP-Structure** 機能は、文書を「テキスト」「表」「画像」の領域に分割し、特に表構造（セル配置）の復元能力においてOSSの中で極めて高い性能を持っています。
3.  **日本語認識精度**:
    *   EasyOCRと比較して、複雑なレイアウト内の日本語テキストの認識精度が高いことが検証済みです。
4.  **アーキテクチャ適合**:
    *   MarkBridgeは既にPython仮想環境 (`.venv`) を利用する仕組みを持っており、PythonベースのPaddleOCRはスムーズに統合可能でした。

## 3. 実装された主な機能
*   **エンジン統合**: `PPStructureV3`を採用し、高度なレイアウト分析と表認識を実現。
*   **結果変換**: PaddleOCRの解析結果を直接マークダウンに変換し、表構造を維持するロジックを実装。
*   **GPUアクセラレーション**: CUDA 12.9互換ビルドを使用し、RTX 50シリーズ（Compute Capability 12.0）などの最新GPUをサポート。
*   **堅牢な環境管理**:
    *   Python仮想環境（venv）の自動作成。
    *   PaddlePaddle GPU版（カスタムインデックス）と標準PyPI依存関係の両方を適切に扱うカスタムインストールロジック。
    *   Windows特有のDLL読み込み問題（`cublas`、`zlibwapi`等）を解決するため、実行時にDLLパスを動的に注入する仕組み。
*   **実行モードの厳格化**:
    *   **厳格なCPUモード**: シンプルで互換性の高い実行を保証。
    *   **厳格なGPUモード**: GPU利用を強制。初期化失敗時は処理を中止し、意図しないCPUフォールバックによるパフォーマンス低下を防ぐ。

## 4. 技術的実装の詳細

### バックエンド (C#)
*   **`ConversionService.cs`**:
    *   変換プロセス全体の制御。
    *   Pythonスクリプトに対し、必要なフラグ（`--lang`, `--use_gpu`）を引数として渡す。
*   **`PythonEnvironmentService.cs`**:
    *   **インストールロジック**: 複数のパッケージソースを扱うため、`pip install`プロセスを2段階に分割：
        1.  公式Paddleカスタムインデックス（`.../stable/cu129/`）から、高性能なGPUエンジン（`paddlepaddle-gpu`）をインストール。
        2.  標準のPyPIリポジトリから、その他の依存ライブラリ（`paddleocr`, `opencv-python-headless`, `pymupdf`）をインストール。

### フロントエンド (Blazor)
*   **`Settings.razor`**:
    *   PaddleOCR専用の管理UIを追加。インストール状況の確認や、環境の再構築が可能。
*   **`Convert.razor`**:
    *   エンジン選択リストに「PaddleOCR」を追加。
    *   「Use GPU」の切り替えトグルを追加。

### スクリプト (Python)
*   **`paddle_convert.py`**:
    *   PaddleOCR APIと連携するコアスクリプト。
    *   非推奨となった`use_gpu`引数を廃止し、新しいAPI仕様である`device='gpu'` / `device='cpu'`への移行を実施。
    *   **DLL Hell（依存関係欠落）の修正**: 仮想環境内の`nvidia`および`torch`ライブラリパスを自動的に検索し、実行時にWindowsのDLL検索パスへ追加するロジックを実装。これにより、`cublas64_12.dll`などの読み込みエラーによるクラッシュを回避。

## 5. 課題と解決策

| 課題 | 原因 | 解決策 |
| :--- | :--- | :--- |
| **`KeyError: 'bbox'`** | `PPStructure` APIのV2とV3の仕様差異。 | 手動解析をやめ、V3組み込みの`save_to_markdown`メソッドを使用するようにリファクタリング。 |
| **GPUアーキテクチャ不適合** | PaddlePaddleデフォルト（CUDA 11.8）がRTX 50（Arch 120）未対応。 | Paddle公式が提供する **CUDA 12.9 (cu129)** 対応ビルドへ切り替え。 |
| **インストール失敗** | `pip install`で`-i`を指定するとPyPIパッケージ（`paddleocr`）が見つからない。 | インストールコマンドを2回に分割（プライベートインデックス用とPyPI用）して実行。 |
| **DLL読み込み失敗** | Windowsがvenv内のネストされたDLLフォルダ（`cublas`, `zlibwapi`）を認識できない。 | `nvidia/*` および `torch/lib` フォルダを動的に検索し、`os.add_dll_directory`で登録するコードを追加。 |
| **意図しないCPU利用** | GPU初期化失敗時に、警告のみでCPUへフォールバックしていた。 | 厳格なチェックを実装。`use_gpu`有効時はデバイス認識を検証し、失敗した場合は明示的にエラー終了させる仕様に変更。 |

## 6. 現在のステータス
*   **バージョン**: `v0.0.11-alpha1`
*   **検証結果**:
    *   CUDA 12.9環境の正常なインストールを確認。
    *   日本語PDFの変換（テキストおよび表構造）を確認。
    *   CPUモードとGPUモードが設定通りに厳密に動作することを確認。

## 7. 既知の制限事項
*   **初回実行時の待機時間**: 初回実行時は約200MB以上のモデルファイルをダウンロードするため、数分の時間がかかります（正常な動作）。
*   **DLL依存関係**: `nvidia` pipパッケージのディレクトリ構造に依存しています。将来的にパッケージ構成が大きく変わった場合、`paddle_convert.py`内のパス調整が必要になる可能性があります。
*   **フォント表示**: デフォルトで使用される高精度モデル（`PP-OCRv5_server`）は多言語対応（中国語ベース）のため、変換結果のテキストで一部の漢字が「簡体字（中華フォント）」の字形で表示されることがあります。
    *   日本語特化の `PP-OCRv3` モデルへ強制的に切り替えることも可能ですが、認識精度が著しく低下するため、現状では**精度を優先してV5モデル（中華フォントあり）**を採用しています。
    *   将来的には、Markdownビューワー側でのフォント指定（HTMLラッパー）や、日本語V4/V5モデルの登場により解決される見込みです。
