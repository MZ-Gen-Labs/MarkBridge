@page "/settings"
@inject Services.AppStateService AppState
@inject Services.PythonEnvironmentService PythonEnv
@inject IJSRuntime JS
@implements IDisposable

<div class="container-fluid p-4">
    <h4 class="mb-4"><i class="bi bi-gear me-2"></i>Settings</h4>

    <!-- 1. System Python Installation -->
    <div class="settings-card mb-4">
        <div class="card-header d-flex align-items-center">
            <span class="badge bg-primary me-2">1</span>
            System Python Installation
        </div>
        <div class="card-body">
            <div class="row align-items-end mb-3">
                <div class="col">
                    <label class="form-label">System Python Path:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="pythonPath" placeholder="python.exe path" />
                        <button class="btn btn-outline-secondary" @onclick="BrowsePython">
                            <i class="bi bi-folder2-open"></i> Browse...
                        </button>
                        <button class="btn btn-outline-primary" @onclick="AutoDetectPython" disabled="@isDetecting">
                            @if (isDetecting)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi bi-search"></i> Auto-Detect
                        </button>
                    </div>
                </div>
            </div>
            
            @if (!string.IsNullOrEmpty(pythonStatus))
            {
                <div class="status-indicator @pythonStatusClass">
                    <i class="bi @pythonStatusIcon me-2"></i>
                    @pythonStatus
                </div>
            }
            
            @if (showPythonDownload)
            {
                <div class="alert alert-info mt-3 mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Python 3.10 or later is required.
                    <a href="https://www.python.org/downloads/" target="_blank" class="alert-link">
                        Download Python <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </div>
            }
            
            <!-- Python Version Manager -->
            @if (pyInstallerAvailable)
            {
                <div class="mt-4">
                    <h6 class="fw-bold mb-3"><i class="bi bi-list-check me-2"></i>Python Version Manager</h6>
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Version</th>
                                <th>Status</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var version in pythonVersions)
                            {
                                <tr>
                                    <td><strong>@version.Version</strong></td>
                                    <td>
                                        @if (version.IsInstalled)
                                        {
                                            <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Installed</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Available</span>
                                        }
                                    </td>
                                    <td>
                                        @if (version.IsInstalled)
                                        {
                                            @if (version.IsActive)
                                            {
                                                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Active</span>
                                            }
                                            else
                                            {
                                                <button class="btn btn-outline-success btn-sm"
                                                        @onclick="() => ShowSetActiveConfirm(version)"
                                                        disabled="@isInstallingVersion">
                                                    <i class="bi bi-check2-circle"></i> Set Active
                                                </button>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (version.IsInstalled)
                                        {
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    @onclick="() => ShowUninstallConfirm(version)"
                                                    disabled="@isInstallingVersion">
                                                <i class="bi bi-trash"></i> Uninstall
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    @onclick="() => ShowInstallConfirm(version)"
                                                    disabled="@isInstallingVersion">
                                                @if (isInstallingVersion && installingVersionName == version.Version)
                                                {
                                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                                }
                                                <i class="bi bi-download"></i> Install
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <button class="btn btn-outline-secondary btn-sm" @onclick="RefreshVersions" disabled="@isRefreshingVersions">
                        @if (isRefreshingVersions)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            }
        </div>
    </div>

    <!-- 2. Virtual Environment -->
    <div class="settings-card mb-4">
        <div class="card-header d-flex align-items-center">
            <span class="badge bg-primary me-2">2</span>
            MarkBridge Virtual Environment
        </div>
        <div class="card-body">
            <div class="row align-items-end mb-3">
                <div class="col">
                    <label class="form-label">Virtual Environment Path:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="venvPath" />
                        <button class="btn btn-outline-secondary" @onclick="BrowseVenv">
                            <i class="bi bi-folder2-open"></i> Browse...
                        </button>
                    </div>
                </div>
            </div>

            <div class="d-flex align-items-center justify-content-between">
                <div class="status-indicator @venvStatusClass">
                    <i class="bi @venvStatusIcon me-2"></i>
                    @venvStatus
                </div>
                <div class="btn-group">
                    @if (!venvExists)
                    {
                        <button class="btn btn-success" @onclick="CreateVenv" disabled="@(isVenvProcessing || string.IsNullOrEmpty(pythonPath))">
                            @if (isVenvProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi bi-plus-circle me-1"></i> Create Virtual Environment
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-outline-warning" @onclick="RebuildVenv" disabled="@isVenvProcessing">
                            @if (isVenvProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi bi-arrow-clockwise me-1"></i> Rebuild Environment
                        </button>
                        <button class="btn btn-outline-danger" @onclick="DeleteVenv" disabled="@isVenvProcessing">
                            <i class="bi bi-trash me-1"></i> Delete Venv
                        </button>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(venvLog))
            {
                <div class="mt-3">
                    <label class="form-label d-flex justify-content-between">
                        <span>Log:</span>
                        <button class="btn btn-sm btn-link p-0" @onclick="() => venvLog = string.Empty">Clear</button>
                    </label>
                    <pre class="bg-dark text-light p-2 rounded" style="max-height: 150px; overflow-y: auto; font-size: 0.8rem;">@venvLog</pre>
                </div>
            }
        </div>
    </div>

    <!-- 3. Library Installation -->
    <div class="settings-card mb-4">
        <div class="card-header d-flex align-items-center">
            <span class="badge bg-primary me-2">3</span>
            MarkBridge Environment Setup
        </div>
        <div class="card-body">
            @if (!venvExists)
            {
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Please create a virtual environment first.
                </div>
            }
            else
            {
                <!-- Install All Button -->
                <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                    <div>
                        <strong>Install All</strong>
                        <span class="text-muted ms-2">Install all required packages at once</span>
                    </div>
                    <button class="btn btn-success" @onclick="InstallAllPackages" disabled="@isInstalling">
                        @if (isInstalling && installingPackage == "all")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                            <span>Installing...</span>
                        }
                        else
                        {
                            <i class="bi bi-download me-1"></i>
                            <span>Install All Packages</span>
                        }
                    </button>
                </div>
                <!-- MarkItDown -->
                <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                    <div>
                        <strong>MarkItDown</strong>
                        <span class="text-muted ms-2">Standard converter, fast and lightweight</span>
                        @if (!string.IsNullOrEmpty(markitdownVersion))
                        {
                            <span class="badge bg-success ms-2">v@(markitdownVersion)</span>
                        }
                    </div>
                    <div class="btn-group">
                        <button class="btn @(markitdownInstalled ? "btn-outline-secondary" : "btn-primary")" 
                                @onclick="InstallMarkItDown" disabled="@isInstalling">
                            @if (isInstalling && installingPackage == "markitdown")
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi @(markitdownInstalled ? "bi-arrow-clockwise" : "bi-download") me-1"></i>
                            @(markitdownInstalled ? "Update" : "Install")
                        </button>
                        @if (markitdownInstalled)
                        {
                            <button class="btn btn-outline-danger" @onclick="UninstallMarkItDown" disabled="@isInstalling">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                        }
                    </div>
                </div>

                <!-- Docling -->
                <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                    <div>
                        <strong>Docling</strong>
                        <span class="text-muted ms-2">Advanced PDF parsing, OCR support</span>
                        @if (!string.IsNullOrEmpty(doclingVersion))
                        {
                            <span class="badge bg-success ms-2">v@(doclingVersion)</span>
                        }
                    </div>
                    <div class="btn-group">
                        <button class="btn @(doclingInstalled ? "btn-outline-secondary" : "btn-primary")" 
                                @onclick="InstallDocling" disabled="@isInstalling">
                            @if (isInstalling && installingPackage == "docling")
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi @(doclingInstalled ? "bi-arrow-clockwise" : "bi-download") me-1"></i>
                            @(doclingInstalled ? "Update" : "Install")
                        </button>
                        @if (doclingInstalled)
                        {
                            <button class="btn btn-outline-danger" @onclick="UninstallDocling" disabled="@isInstalling">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                        }
                    </div>
                </div>

                <!-- Docling OCR Engines Section -->
                <div class="mb-3">
                    <h6 class="text-muted mb-2"><i class="bi bi-eye me-1"></i>Docling OCR Engines</h6>
                    <p class="text-muted small mb-2">These OCR engines enable scanned PDF support in Docling:</p>
                </div>

                <!-- EasyOCR (for Docling OCR) -->
                <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom ps-3">
                    <div>
                        <strong>EasyOCR</strong>
                        <span class="text-muted ms-2">GPU accelerated, 80+ languages (recommended)</span>
                        @if (!string.IsNullOrEmpty(easyocrVersion))
                        {
                            <span class="badge bg-success ms-2">v@(easyocrVersion)</span>
                        }
                    </div>
                    <div class="btn-group">
                        <button class="btn @(easyocrInstalled ? "btn-outline-secondary" : "btn-primary")" 
                                @onclick="InstallEasyOcr" disabled="@isInstalling">
                            @if (isInstalling && installingPackage == "easyocr")
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi @(easyocrInstalled ? "bi-arrow-clockwise" : "bi-download") me-1"></i>
                            @(easyocrInstalled ? "Update" : "Install")
                        </button>
                        @if (easyocrInstalled)
                        {
                            <button class="btn btn-outline-danger" @onclick="UninstallEasyOcr" disabled="@isInstalling">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                        }
                    </div>
                </div>

                <!-- RapidOCR (for Docling OCR) -->
                <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom ps-3">
                    <div>
                        <strong>RapidOCR</strong>
                        <span class="text-muted ms-2">Faster, lightweight (alternative to EasyOCR)</span>
                        @if (!string.IsNullOrEmpty(rapidocrVersion))
                        {
                            <span class="badge bg-success ms-2">v@(rapidocrVersion)</span>
                        }
                    </div>
                    <div class="btn-group">
                        <button class="btn @(rapidocrInstalled ? "btn-outline-secondary" : "btn-primary")" 
                                @onclick="InstallRapidOcr" disabled="@isInstalling">
                            @if (isInstalling && installingPackage == "rapidocr")
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi @(rapidocrInstalled ? "bi-arrow-clockwise" : "bi-download") me-1"></i>
                            @(rapidocrInstalled ? "Update" : "Install")
                        </button>
                        @if (rapidocrInstalled)
                        {
                            <button class="btn btn-outline-danger" @onclick="UninstallRapidOcr" disabled="@isInstalling">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                        }
                    </div>
                </div>

                <!-- PaddleOCR Section -->
                <div class="mb-3 mt-4">
                    <h6 class="text-muted mb-2"><i class="bi bi-grid-3x3 me-1"></i>PaddleOCR (PP-Structure)</h6>
                    <p class="text-muted small mb-2">Advanced layout analysis and table recognition. CPU and GPU versions are mutually exclusive.</p>
                </div>

                <div class="ps-3 mb-3 pb-3 border-bottom">
                    <!-- Current Installation Status -->
                    @if (paddleOcrInstalled)
                    {
                        <div class="alert alert-info py-2 mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Installed:</strong> PaddleOCR v@(paddleOcrVersion) 
                            @if (paddleGpuInstalled)
                            {
                                <span class="badge bg-success ms-2">GPU (CUDA 12.9)</span>
                                <span class="text-muted small ms-2">- Supports both GPU and CPU processing</span>
                            }
                            else if (paddleCpuInstalled)
                            {
                                <span class="badge bg-secondary ms-2">CPU Only</span>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-secondary py-2 mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Not installed.</strong> Choose a version below:
                            <ul class="mb-0 mt-1 small">
                                <li><strong>CPU Only</strong> - Works on any system, no GPU required</li>
                                <li><strong>GPU</strong> <span class="badge bg-primary">Recommended</span> - CUDA 12.9, includes CPU fallback</li>
                            </ul>
                        </div>
                    }

                    <!-- Action Buttons -->
                    <div class="d-flex gap-2 justify-content-end">
                        @if (!paddleOcrInstalled)
                        {
                            <button class="btn btn-primary" @onclick="InstallPaddleOcrCpu" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "paddleocr-cpu")
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="bi bi-download me-1"></i>Install CPU Version
                            </button>
                            <button class="btn btn-success" @onclick="InstallPaddleOcrGpu" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "paddleocr-gpu")
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="bi bi-download me-1"></i>Install GPU Version
                            </button>
                        }
                        else if (paddleCpuInstalled && !paddleGpuInstalled)
                        {
                            <button class="btn btn-success" @onclick="SwitchToGpuVersion" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "paddleocr-switch-gpu")
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="bi bi-arrow-up-circle me-1"></i>Upgrade to GPU Version
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="InstallPaddleOcrCpu" disabled="@isInstalling">
                                <i class="bi bi-arrow-clockwise me-1"></i>Update
                            </button>
                            <button class="btn btn-outline-danger" @onclick="UninstallPaddleOcr" disabled="@isInstalling">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                        }
                        else if (paddleGpuInstalled)
                        {
                            <button class="btn btn-outline-secondary" @onclick="SwitchToCpuVersion" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "paddleocr-switch-cpu")
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="bi bi-arrow-down-circle me-1"></i>Downgrade to CPU Only
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="InstallPaddleOcrGpu" disabled="@isInstalling">
                                <i class="bi bi-arrow-clockwise me-1"></i>Update
                            </button>
                            <button class="btn btn-outline-danger" @onclick="UninstallPaddleOcr" disabled="@isInstalling">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                        }
                    </div>
                </div>

                <!-- CUDA Support (for Docling) -->
                <div class="mb-3 mt-4">
                    <h6 class="text-muted mb-2"><i class="bi bi-gpu-card me-1"></i>Docling GPU Acceleration</h6>
                    <p class="text-muted small mb-2">PyTorch CUDA for Docling GPU mode (separate from PaddleOCR):</p>
                </div>

                <div class="d-flex align-items-center justify-content-between ps-3">
                    <div>
                        <strong>PyTorch CUDA</strong>
                        <span class="text-muted ms-2">GPU acceleration for Docling (PyTorch)</span>
                        @if (cudaInstalled && !string.IsNullOrEmpty(cudaVersion))
                        {
                            <span class="badge bg-success ms-2">CUDA @cudaVersion</span>
                            <span class="badge bg-info ms-1">PyTorch @torchVersion</span>
                        }
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" @onclick="() => InstallCuda(false)" disabled="@isInstalling">
                            @if (isInstalling && installingPackage == "cuda")
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi bi-gpu-card me-1"></i> @(cudaInstalled ? "Reinstall" : "Install") CUDA 12.4
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="() => InstallCuda(true)" disabled="@isInstalling"
                                title="For RTX 50 series (Blackwell) - requires CUDA 12.8">
                            @if (isInstalling && installingPackage == "cuda-nightly")
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi bi-lightning me-1"></i> Nightly (RTX 50xx)
                        </button>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(installLog))
                {
                    <div class="mt-3">
                        <label class="form-label d-flex justify-content-between">
                            <span>Installation Log:</span>
                            <button class="btn btn-sm btn-link p-0" @onclick="() => installLog = string.Empty">Clear</button>
                        </label>
                        <pre class="bg-dark text-light p-2 rounded" style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;">@installLog</pre>
                    </div>
                }
            }
        </div>
    </div>

    <!-- 4. Application Settings -->
    <div class="settings-card">
        <div class="card-header d-flex align-items-center">
            <span class="badge bg-primary me-2">4</span>
            Application Settings
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="autoSave" @bind="AutoSaveEnabled" />
                        <label class="form-check-label" for="autoSave">
                            <i class="bi bi-save me-1"></i> Auto-save in Editor
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><i class="bi bi-translate me-1"></i> Language</label>
                    <select class="form-select" @bind="Language">
                        <option value="en">English</option>
                        <option value="ja">日本語</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><i class="bi bi-palette me-1"></i> Theme</label>
                    <select class="form-select" @bind="Theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><i class="bi bi-speedometer2 me-1"></i> Max Concurrent Conversions: @MaxConcurrency</label>
                    <input type="range" class="form-range" min="1" max="8" @bind="MaxConcurrency" />
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
@if (showConfirmDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@confirmDialogTitle</h5>
                    <button type="button" class="btn-close" @onclick="CancelConfirm"></button>
                </div>
                <div class="modal-body">
                    <p>@confirmDialogMessage</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelConfirm">Cancel</button>
                    <button type="button" class="btn @confirmDialogButtonClass" @onclick="ConfirmAction">@confirmDialogButtonText</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Python
    private string pythonPath = string.Empty;
    private string pythonStatus = string.Empty;
    private string pythonStatusClass = string.Empty;
    private string pythonStatusIcon = string.Empty;
    private bool isDetecting = false;
    private bool showPythonDownload = false;
    
    // Python Install Manager
    private bool pyInstallerAvailable = false;
    private List<MarkBridge.Services.PythonVersionInfo> pythonVersions = new();
    private bool isInstallingVersion = false;
    private string installingVersionName = "";
    private bool isRefreshingVersions = false;

    // Venv (Legacy - for backward compatibility)
    private string venvPath = string.Empty;
    private string venvStatus = "Not configured";
    private string venvStatusClass = "status-warning";
    private string venvStatusIcon = "bi-exclamation-triangle";
    private bool venvExists = false;
    private bool isVenvProcessing = false;
    private string venvLog = string.Empty;

    // Engine-specific Venvs
    private string markitdownVenvPath = string.Empty;
    private string doclingVenvPath = string.Empty;
    private string paddleVenvPath = string.Empty;
    private bool markitdownVenvExists = false;
    private bool doclingVenvExists = false;
    private bool paddleVenvExists = false;

    // Packages
    private bool markitdownInstalled = false;
    private string? markitdownVersion;
    private bool doclingInstalled = false;
    private string? doclingVersion;
    private bool easyocrInstalled = false;
    private string? easyocrVersion;
    private bool rapidocrInstalled = false;
    private string? rapidocrVersion;
    private bool paddleOcrInstalled = false;
    private string? paddleOcrVersion;
    private bool paddleCpuInstalled = false;
    private bool paddleGpuInstalled = false;
    private bool cudaInstalled = false;
    private string? torchVersion;
    private string? cudaVersion;
    private bool isInstalling = false;
    private string installingPackage = string.Empty;
    private string installLog = string.Empty;

    // App settings
    private bool autoSaveEnabled;
    private string language = "en";
    private string theme = "light";
    private int maxConcurrency = 3;

    // Confirmation dialog
    private bool showConfirmDialog = false;
    private string confirmDialogTitle = "";
    private string confirmDialogMessage = "";
    private string confirmDialogButtonText = "Confirm";
    private string confirmDialogButtonClass = "btn-primary";
    private Func<Task>? pendingConfirmAction;

    private Action? _stateHandler;


    protected override async Task OnInitializedAsync()
    {
        _stateHandler = async () => await InvokeAsync(StateHasChanged);
        AppState.OnChange += _stateHandler;

        // Ensure settings are loaded first
        await AppState.InitializeAsync();

        // Load current settings
        pythonPath = AppState.SystemPythonPath;
        venvPath = AppState.VirtualEnvPath;
        autoSaveEnabled = AppState.AutoSaveEnabled;
        language = AppState.Language;
        theme = AppState.Theme;
        maxConcurrency = AppState.MaxConcurrency;

        // Check current state
        await CheckPythonStatus();
        await CheckVenvStatus();
        
        // Check Python Install Manager availability
        pyInstallerAvailable = await PythonEnv.IsPyInstallerAvailableAsync();
        if (pyInstallerAvailable)
        {
            await RefreshVersions();
        }
        // Load engine-specific venv paths
        markitdownVenvPath = AppState.MarkItDownVenvPath;
        doclingVenvPath = AppState.DoclingVenvPath;
        paddleVenvPath = AppState.PaddleVenvPath;

        // Check engine venv status
        await CheckEngineVenvStatus();

        // Auto-detect installed packages
        await CheckInstalledPackages();
    }

    #region Python Methods

    private async Task AutoDetectPython()
    {
        isDetecting = true;
        pythonStatus = "Detecting Python...";
        pythonStatusClass = "status-processing";
        pythonStatusIcon = "bi-hourglass-split";
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.AutoDetectPythonAsync());

        if (result.found)
        {
            pythonPath = result.path;
            AppState.SystemPythonPath = result.path;
            AppState.PythonVersion = result.version;
            pythonStatus = $"Python {result.version} found.";
            pythonStatusClass = "status-ready";
            pythonStatusIcon = "bi-check-circle-fill";
            showPythonDownload = false;
        }
        else
        {
            pythonStatus = "Python not found.";
            pythonStatusClass = "status-error";
            pythonStatusIcon = "bi-x-circle-fill";
            showPythonDownload = true;
        }

        isDetecting = false;
        StateHasChanged();
    }

    private async Task BrowsePython()
    {
        try
        {
            var options = new PickOptions
            {
                PickerTitle = "Select python.exe",
                FileTypes = new FilePickerFileType(new Dictionary<DevicePlatform, IEnumerable<string>>
                {
                    { DevicePlatform.WinUI, new[] { ".exe" } }
                })
            };

            var result = await FilePicker.Default.PickAsync(options);
            if (result != null)
            {
                pythonPath = result.FullPath;
                await CheckPythonStatus();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"FilePicker error: {ex.Message}");
        }
    }

    private async Task CheckPythonStatus()
    {
        if (string.IsNullOrEmpty(pythonPath))
        {
            pythonStatus = "No Python path configured.";
            pythonStatusClass = "status-warning";
            pythonStatusIcon = "bi-exclamation-triangle";
            showPythonDownload = true;
            return;
        }

        var result = await Task.Run(() => PythonEnv.ValidatePythonAsync(pythonPath));
        if (result.isValid)
        {
            pythonPath = result.fullPath;
            AppState.SystemPythonPath = result.fullPath;
            AppState.PythonVersion = result.version;
            pythonStatus = $"Python {result.version} found.";
            pythonStatusClass = "status-ready";
            pythonStatusIcon = "bi-check-circle-fill";
            showPythonDownload = false;
        }
        else
        {
            pythonStatus = "Invalid Python path or version < 3.10.";
            pythonStatusClass = "status-error";
            pythonStatusIcon = "bi-x-circle-fill";
            showPythonDownload = true;
        }
    }

    #endregion

    #region Python Install Manager

    private async Task RefreshVersions()
    {
        isRefreshingVersions = true;
        StateHasChanged();

        try
        {
            var installedVersions = await PythonEnv.GetInstalledVersionsAsync();
            var availableVersions = PythonEnv.GetAvailableVersions();

            // Merge installed and available versions
            pythonVersions.Clear();

            foreach (var av in availableVersions)
            {
                var installed = installedVersions.FirstOrDefault(iv => iv.Version.StartsWith(av));
                if (installed != null)
                {
                    pythonVersions.Add(installed);
                }
                else
                {
                    pythonVersions.Add(new MarkBridge.Services.PythonVersionInfo
                    {
                        Version = av,
                        Tag = av,  // Available versions have same Version and Tag
                        IsInstalled = false,
                        IsActive = false
                    });
                }
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"RefreshVersions error: {ex.Message}");
        }
        finally
        {
            isRefreshingVersions = false;
            StateHasChanged();
        }
    }

    private async Task InstallPythonVersion(string version)
    {
        isInstallingVersion = true;
        installingVersionName = version;
        StateHasChanged();

        try
        {
            var result = await PythonEnv.InstallPythonVersionAsync(version, msg =>
            {
                venvLog = msg;
                InvokeAsync(StateHasChanged);
            });

            if (result.success)
            {
                await RefreshVersions();
            }
        }
        finally
        {
            isInstallingVersion = false;
            installingVersionName = "";
            StateHasChanged();
        }
    }

    private void ShowUninstallConfirm(MarkBridge.Services.PythonVersionInfo version)
    {
        confirmDialogTitle = "Uninstall Python";
        confirmDialogMessage = $"Are you sure you want to uninstall Python {version.Version}?";
        confirmDialogButtonText = "Uninstall";
        confirmDialogButtonClass = "btn-danger";
        pendingConfirmAction = async () =>
        {
            isInstallingVersion = true;
            installingVersionName = version.Version;
            StateHasChanged();

            var result = await PythonEnv.UninstallPythonVersionAsync(version.Tag, msg =>
            {
                venvLog = msg;
                InvokeAsync(StateHasChanged);
            });

            await RefreshVersions();
            isInstallingVersion = false;
            installingVersionName = "";
            StateHasChanged();
        };
        showConfirmDialog = true;
        StateHasChanged();
    }

    private void ShowInstallConfirm(MarkBridge.Services.PythonVersionInfo version)
    {
        confirmDialogTitle = "Install Python";
        confirmDialogMessage = $"Do you want to install Python {version.Version}?";
        confirmDialogButtonText = "Install";
        confirmDialogButtonClass = "btn-primary";
        pendingConfirmAction = async () =>
        {
            isInstallingVersion = true;
            installingVersionName = version.Version;
            StateHasChanged();

            var result = await PythonEnv.InstallPythonVersionAsync(version.Tag, msg =>
            {
                venvLog = msg;
                InvokeAsync(StateHasChanged);
            });

            await RefreshVersions();
            isInstallingVersion = false;
            installingVersionName = "";
            StateHasChanged();
        };
        showConfirmDialog = true;
        StateHasChanged();
    }

    private void ShowSetActiveConfirm(MarkBridge.Services.PythonVersionInfo version)
    {
        confirmDialogTitle = "Set Active Python";
        confirmDialogMessage = $"Do you want to set Python {version.Version} as the active version?";
        confirmDialogButtonText = "Set Active";
        confirmDialogButtonClass = "btn-success";
        pendingConfirmAction = async () =>
        {
            isInstallingVersion = true;
            StateHasChanged();

            var result = await PythonEnv.SetActiveVersionAsync(version.Tag);
            
            if (result.success)
            {
                foreach (var v in pythonVersions)
                {
                    v.IsActive = false;
                }
                version.IsActive = true;
                
                pythonPath = AppState.SystemPythonPath;
                await CheckPythonStatus();
            }

            isInstallingVersion = false;
            StateHasChanged();
        };
        showConfirmDialog = true;
        StateHasChanged();
    }

    #endregion

    #region Venv Methods

    private async Task CheckVenvStatus()
    {
        if (string.IsNullOrEmpty(venvPath))
        {
            venvPath = AppState.VirtualEnvPath;
        }

        venvExists = PythonEnv.IsVenvValid(venvPath);

        if (venvExists)
        {
            venvStatus = "Ready to use";
            venvStatusClass = "status-ready";
            venvStatusIcon = "bi-check-circle-fill";
            AppState.IsVenvActive = true;

            // Check installed packages
            await CheckInstalledPackages();
        }
        else
        {
            venvStatus = "Virtual environment not found";
            venvStatusClass = "status-warning";
            venvStatusIcon = "bi-exclamation-triangle";
            AppState.IsVenvActive = false;
        }

        StateHasChanged();
    }

    private async Task CheckEngineVenvStatus()
    {
        markitdownVenvExists = PythonEnv.IsVenvValid(markitdownVenvPath);
        doclingVenvExists = PythonEnv.IsVenvValid(doclingVenvPath);
        paddleVenvExists = PythonEnv.IsVenvValid(paddleVenvPath);
        
        AppState.IsMarkItDownVenvActive = markitdownVenvExists;
        AppState.IsDoclingVenvActive = doclingVenvExists;
        AppState.IsPaddleVenvActive = paddleVenvExists;
        
        await Task.CompletedTask;
    }

    #region Engine Setup Methods

    private async Task SetupMarkItDown()
    {
        isInstalling = true;
        installingPackage = "markitdown-setup";
        installLog = "=== Setting up MarkItDown Environment ===\n";
        AppState.SetStatus("Setting up MarkItDown...", true);
        StateHasChanged();

        try
        {
            installLog += "Creating virtual environment...\n";
            var venvResult = await Task.Run(() => PythonEnv.CreateVenvAsync(pythonPath, markitdownVenvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            if (!venvResult.success)
            {
                installLog += $"Error: {venvResult.message}\n";
                return;
            }

            installLog += "\nInstalling MarkItDown...\n";
            var installResult = await Task.Run(() => PythonEnv.InstallMarkItDownAsync(markitdownVenvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            installLog += $"\n{installResult.message}\n";
        }
        finally
        {
            isInstalling = false;
            installingPackage = string.Empty;
            AppState.SetStatus("Ready");
            await CheckEngineVenvStatus();
            await CheckInstalledPackages();
            StateHasChanged();
        }
    }

    private Task DeleteMarkItDownVenv()
    {
        ShowConfirmDialog(
            "Delete MarkItDown Environment",
            "Are you sure you want to delete the MarkItDown virtual environment?",
            "Delete",
            "btn-danger",
            async () =>
            {
                isInstalling = true;
                StateHasChanged();
                var result = await Task.Run(() => PythonEnv.DeleteVenv(markitdownVenvPath));
                installLog = result.message;
                isInstalling = false;
                await CheckEngineVenvStatus();
                await CheckInstalledPackages();
                StateHasChanged();
            });
        return Task.CompletedTask;
    }

    private async Task ReinstallMarkItDown()
    {
        await Task.Run(() => PythonEnv.DeleteVenv(markitdownVenvPath));
        await SetupMarkItDown();
    }

    private async Task SetupDocling()
    {
        isInstalling = true;
        installingPackage = "docling-setup";
        installLog = "=== Setting up Docling Environment ===\n";
        AppState.SetStatus("Setting up Docling...", true);
        StateHasChanged();

        try
        {
            installLog += "Creating virtual environment...\n";
            var venvResult = await Task.Run(() => PythonEnv.CreateVenvAsync(pythonPath, doclingVenvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            if (!venvResult.success)
            {
                installLog += $"Error: {venvResult.message}\n";
                return;
            }

            installLog += "\nInstalling Docling...\n";
            var installResult = await Task.Run(() => PythonEnv.InstallDoclingAsync(doclingVenvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            installLog += $"\n{installResult.message}\n";
        }
        finally
        {
            isInstalling = false;
            installingPackage = string.Empty;
            AppState.SetStatus("Ready");
            await CheckEngineVenvStatus();
            await CheckInstalledPackages();
            StateHasChanged();
        }
    }

    private Task DeleteDoclingVenv()
    {
        ShowConfirmDialog(
            "Delete Docling Environment",
            "Are you sure you want to delete the Docling virtual environment?",
            "Delete",
            "btn-danger",
            async () =>
            {
                isInstalling = true;
                StateHasChanged();
                var result = await Task.Run(() => PythonEnv.DeleteVenv(doclingVenvPath));
                installLog = result.message;
                isInstalling = false;
                await CheckEngineVenvStatus();
                await CheckInstalledPackages();
                StateHasChanged();
            });
        return Task.CompletedTask;
    }

    private async Task ReinstallDocling()
    {
        await Task.Run(() => PythonEnv.DeleteVenv(doclingVenvPath));
        await SetupDocling();
    }

    private async Task SetupPaddleCpu() => await SetupPaddle(false);
    private async Task SetupPaddleGpu() => await SetupPaddle(true);

    private async Task SetupPaddle(bool useGpu)
    {
        isInstalling = true;
        installingPackage = useGpu ? "paddle-gpu-setup" : "paddle-cpu-setup";
        installLog = $"=== Setting up PaddleOCR {(useGpu ? "GPU" : "CPU")} Environment ===\n";
        AppState.SetStatus($"Setting up PaddleOCR {(useGpu ? "GPU" : "CPU")}...", true);
        StateHasChanged();

        try
        {
            installLog += "Creating virtual environment...\n";
            var venvResult = await Task.Run(() => PythonEnv.CreateVenvAsync(pythonPath, paddleVenvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            if (!venvResult.success)
            {
                installLog += $"Error: {venvResult.message}\n";
                return;
            }

            installLog += $"\nInstalling PaddleOCR {(useGpu ? "GPU" : "CPU")}...\n";
            var installResult = useGpu
                ? await Task.Run(() => PythonEnv.InstallPaddleOcrGpuAsync(paddleVenvPath, log =>
                {
                    installLog += log + "\n";
                    InvokeAsync(StateHasChanged);
                }))
                : await Task.Run(() => PythonEnv.InstallPaddleOcrCpuAsync(paddleVenvPath, log =>
                {
                    installLog += log + "\n";
                    InvokeAsync(StateHasChanged);
                }));

            installLog += $"\n{installResult.message}\n";
        }
        finally
        {
            isInstalling = false;
            installingPackage = string.Empty;
            AppState.SetStatus("Ready");
            await CheckEngineVenvStatus();
            await CheckInstalledPackages();
            StateHasChanged();
        }
    }

    private Task DeletePaddleVenv()
    {
        ShowConfirmDialog(
            "Delete PaddleOCR Environment",
            "Are you sure you want to delete the PaddleOCR virtual environment?",
            "Delete",
            "btn-danger",
            async () =>
            {
                isInstalling = true;
                StateHasChanged();
                var result = await Task.Run(() => PythonEnv.DeleteVenv(paddleVenvPath));
                installLog = result.message;
                isInstalling = false;
                await CheckEngineVenvStatus();
                await CheckInstalledPackages();
                StateHasChanged();
            });
        return Task.CompletedTask;
    }

    #endregion

    private async Task CreateVenv()
    {
        isVenvProcessing = true;
        venvLog = string.Empty;
        AppState.SetStatus("Creating virtual environment...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.CreateVenvAsync(pythonPath, venvPath, log =>
        {
            venvLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        if (result.success)
        {
            AppState.VirtualEnvPath = venvPath;
            venvLog += "\n" + result.message;
        }
        else
        {
            venvLog += "\nError: " + result.message;
        }

        isVenvProcessing = false;
        AppState.SetStatus("Ready");
        await CheckVenvStatus();
    }

    private async Task RebuildVenv()
    {
        await CreateVenv();
    }

    private Task DeleteVenv()
    {
        ShowConfirmDialog(
            "Delete Virtual Environment",
            "Are you sure you want to delete the virtual environment? This action cannot be undone.",
            "Delete",
            "btn-danger",
            async () =>
            {
                isVenvProcessing = true;
                StateHasChanged();

                var result = await Task.Run(() => PythonEnv.DeleteVenv(venvPath));
                venvLog = result.message;

                isVenvProcessing = false;
                await CheckVenvStatus();
            });
        return Task.CompletedTask;
    }

    private async Task BrowseVenv()
    {
        try
        {
            var result = await FolderPicker.Default.PickAsync();
            if (result.IsSuccessful)
            {
                venvPath = result.Folder.Path;
                await CheckVenvStatus();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"FolderPicker error: {ex.Message}");
        }
    }

    #endregion

    #region Confirmation Dialog

    private void ShowConfirmDialog(string title, string message, string buttonText, string buttonClass, Func<Task> action)
    {
        confirmDialogTitle = title;
        confirmDialogMessage = message;
        confirmDialogButtonText = buttonText;
        confirmDialogButtonClass = buttonClass;
        pendingConfirmAction = action;
        showConfirmDialog = true;
        StateHasChanged();
    }

    private async Task ConfirmAction()
    {
        showConfirmDialog = false;
        if (pendingConfirmAction != null)
        {
            await pendingConfirmAction();
        }
        StateHasChanged();
    }

    private void CancelConfirm()
    {
        showConfirmDialog = false;
        pendingConfirmAction = null;
        StateHasChanged();
    }

    #endregion

    #region Package Installation

    private async Task CheckInstalledPackages()
    {
        var markitdown = await PythonEnv.CheckMarkItDownAsync(venvPath);
        markitdownInstalled = markitdown.installed;
        markitdownVersion = markitdown.version;
        AppState.MarkItDownVersion = markitdown.version;

        var docling = await PythonEnv.CheckDoclingAsync(venvPath);
        doclingInstalled = docling.installed;
        doclingVersion = docling.version;
        AppState.DoclingVersion = docling.version;

        var easyocr = await PythonEnv.CheckEasyOcrAsync(venvPath);
        easyocrInstalled = easyocr.installed;
        easyocrVersion = easyocr.version;

        var rapidocr = await PythonEnv.CheckRapidOcrAsync(venvPath);
        rapidocrInstalled = rapidocr.installed;
        rapidocrVersion = rapidocr.version;

        var paddle = await PythonEnv.CheckPaddleOcrAsync(venvPath);
        paddleOcrInstalled = paddle.installed;
        paddleOcrVersion = paddle.version;

        var paddleCpu = await PythonEnv.CheckPaddleCpuAsync(venvPath);
        paddleCpuInstalled = paddleCpu.installed;

        var paddleGpu = await PythonEnv.CheckPaddleGpuAsync(venvPath);
        paddleGpuInstalled = paddleGpu.installed;

        var cuda = await PythonEnv.CheckCudaAsync(venvPath);
        cudaInstalled = cuda.installed;
        torchVersion = cuda.torchVersion;
        cudaVersion = cuda.cudaVersion;
    }

    private async Task InstallMarkItDown()
    {
        isInstalling = true;
        installingPackage = "markitdown";
        installLog = string.Empty;
        AppState.SetStatus("Installing MarkItDown...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallMarkItDownAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallDocling()
    {
        isInstalling = true;
        installingPackage = "docling";
        installLog = string.Empty;
        AppState.SetStatus("Installing Docling...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallDoclingAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallEasyOcr()
    {
        isInstalling = true;
        installingPackage = "easyocr";
        installLog = string.Empty;
        AppState.SetStatus("Installing EasyOCR...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallEasyOcrAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }
    private async Task InstallRapidOcr()
    {
        isInstalling = true;
        installingPackage = "rapidocr";
        installLog = string.Empty;
        AppState.SetStatus("Installing RapidOCR...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallRapidOcrAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallPaddleOcrCpu()
    {
        isInstalling = true;
        installingPackage = "paddleocr-cpu";
        installLog = string.Empty;
        AppState.SetStatus("Installing PaddleOCR (CPU)...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallPaddleOcrCpuAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallPaddleOcrGpu()
    {
        isInstalling = true;
        installingPackage = "paddleocr-gpu";
        installLog = string.Empty;
        AppState.SetStatus("Installing PaddleOCR (GPU)...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallPaddleOcrGpuAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallCuda(bool useNightly)
    {
        isInstalling = true;
        installingPackage = useNightly ? "cuda-nightly" : "cuda";
        installLog = string.Empty;
        AppState.SetStatus("Installing CUDA support...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallCudaSupportAsync(venvPath, useNightly, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        StateHasChanged();
    }

    private async Task InstallAllPackages()
    {
        isInstalling = true;
        installingPackage = "all";
        installLog = string.Empty;
        AppState.SetStatus("Installing all packages...", true);
        StateHasChanged();

        var packages = new List<(string name, Func<string, Action<string>?, Task<(bool success, string message)>> installer)>
        {
            ("MarkItDown", (venv, log) => PythonEnv.InstallMarkItDownAsync(venv, log)),
            ("Docling", (venv, log) => PythonEnv.InstallDoclingAsync(venv, log)),
            ("EasyOCR", (venv, log) => PythonEnv.InstallEasyOcrAsync(venv, log)),
            ("RapidOCR", (venv, log) => PythonEnv.InstallRapidOcrAsync(venv, log)),
            ("PaddleOCR (CPU)", (venv, log) => PythonEnv.InstallPaddleOcrCpuAsync(venv, log)),
        };

        int successCount = 0;
        int failCount = 0;

        foreach (var (name, installer) in packages)
        {
            installLog += $"\n=== Installing {name} ===\n";
            await InvokeAsync(StateHasChanged);

            var result = await Task.Run(() => installer(venvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            if (result.success)
            {
                successCount++;
                installLog += $"✓ {name} installed successfully.\n";
            }
            else
            {
                failCount++;
                installLog += $"✗ {name} failed: {result.message}\n";
            }
            await InvokeAsync(StateHasChanged);
        }

        installLog += $"\n=== Complete: {successCount} succeeded, {failCount} failed ===\n";
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    #endregion

    #region Package Uninstall

    private async Task UninstallMarkItDown()
    {
        isInstalling = true;
        installingPackage = "markitdown";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling MarkItDown...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallMarkItDownAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task UninstallDocling()
    {
        isInstalling = true;
        installingPackage = "docling";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling Docling...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallDoclingAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task UninstallEasyOcr()
    {
        isInstalling = true;
        installingPackage = "easyocr";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling EasyOCR...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallEasyOcrAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task UninstallRapidOcr()
    {
        isInstalling = true;
        installingPackage = "rapidocr";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling RapidOCR...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallRapidOcrAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task UninstallPaddleOcrCpu()
    {
        isInstalling = true;
        installingPackage = "paddleocr-cpu";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling PaddleOCR (CPU)...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallPaddleOcrCpuAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task UninstallPaddleOcrGpu()
    {
        isInstalling = true;
        installingPackage = "paddleocr-gpu";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling PaddleOCR (GPU)...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallPaddleOcrGpuAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    /// <summary>
    /// Unified uninstall for PaddleOCR (both CPU and GPU)
    /// </summary>
    private async Task UninstallPaddleOcr()
    {
        if (paddleGpuInstalled)
        {
            await UninstallPaddleOcrGpu();
        }
        else if (paddleCpuInstalled)
        {
            await UninstallPaddleOcrCpu();
        }
    }

    /// <summary>
    /// Switch from CPU to GPU version (uninstall CPU, install GPU)
    /// </summary>
    private async Task SwitchToGpuVersion()
    {
        isInstalling = true;
        installingPackage = "paddleocr-switch-gpu";
        installLog = string.Empty;
        AppState.SetStatus("Switching to GPU version...", true);
        StateHasChanged();

        // First uninstall CPU version
        installLog += "=== Uninstalling CPU version ===\n";
        var uninstallResult = await Task.Run(() => PythonEnv.UninstallPaddleOcrCpuAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));
        installLog += uninstallResult.message + "\n\n";

        // Then install GPU version
        installLog += "=== Installing GPU version ===\n";
        var installResult = await Task.Run(() => PythonEnv.InstallPaddleOcrGpuAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));
        installLog += "\n" + installResult.message;

        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    /// <summary>
    /// Switch from GPU to CPU version (uninstall GPU, install CPU)
    /// </summary>
    private async Task SwitchToCpuVersion()
    {
        isInstalling = true;
        installingPackage = "paddleocr-switch-cpu";
        installLog = string.Empty;
        AppState.SetStatus("Switching to CPU version...", true);
        StateHasChanged();

        // First uninstall GPU version
        installLog += "=== Uninstalling GPU version ===\n";
        var uninstallResult = await Task.Run(() => PythonEnv.UninstallPaddleOcrGpuAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));
        installLog += uninstallResult.message + "\n\n";

        // Then install CPU version
        installLog += "=== Installing CPU version ===\n";
        var installResult = await Task.Run(() => PythonEnv.InstallPaddleOcrCpuAsync(venvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));
        installLog += "\n" + installResult.message;

        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    #endregion

    #region App Settings

    private bool AutoSaveEnabled
    {
        get => autoSaveEnabled;
        set
        {
            autoSaveEnabled = value;
            AppState.AutoSaveEnabled = value;
        }
    }

    private string Language
    {
        get => language;
        set
        {
            language = value;
            AppState.Language = value;
        }
    }

    private string Theme
    {
        get => theme;
        set
        {
            theme = value;
            AppState.Theme = value;
            _ = JS.InvokeVoidAsync("setTheme", value);
        }
    }

    private int MaxConcurrency
    {
        get => maxConcurrency;
        set
        {
            maxConcurrency = value;
            AppState.MaxConcurrency = value;
        }
    }

    #endregion

    public void Dispose()
    {
        if (_stateHandler != null)
        {
            AppState.OnChange -= _stateHandler;
        }
    }
}
