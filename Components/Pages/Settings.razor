@page "/settings"
@inject Services.AppStateService AppState
@inject Services.PythonEnvironmentService PythonEnv
@inject IJSRuntime JS
@implements IDisposable

<div class="container-fluid p-4">
    <h4 class="mb-4"><i class="bi bi-gear me-2"></i>Settings</h4>

    <!-- 1. System Python Installation -->
    <div class="settings-card mb-4">
        <div class="card-header d-flex align-items-center">
            <span class="badge bg-primary me-2">1</span>
            System Python Installation
        </div>
        <div class="card-body">
            <div class="row align-items-end mb-3">
                <div class="col">
                    <label class="form-label">System Python Path:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="pythonPath" placeholder="python.exe path" />
                        <button class="btn btn-outline-secondary" @onclick="BrowsePython">
                            <i class="bi bi-folder2-open"></i> Browse...
                        </button>
                        <button class="btn btn-outline-primary" @onclick="AutoDetectPython" disabled="@isDetecting">
                            @if (isDetecting)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi bi-search"></i> Auto-Detect
                        </button>
                    </div>
                </div>
            </div>
            
            @if (!string.IsNullOrEmpty(pythonStatus))
            {
                <div class="status-indicator @pythonStatusClass">
                    <i class="bi @pythonStatusIcon me-2"></i>
                    @pythonStatus
                </div>
            }
            
            @if (showPythonDownload)
            {
                <div class="alert alert-info mt-3 mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Python 3.10 or later is required.
                    <a href="https://www.python.org/downloads/" target="_blank" class="alert-link">
                        Download Python <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </div>
            }
            
            <!-- Python Version Manager -->
            @if (pyInstallerAvailable)
            {
                <div class="mt-4">
                    <div class="d-flex align-items-center justify-content-between" style="cursor: pointer;" @onclick="() => isPythonVersionManagerExpanded = !isPythonVersionManagerExpanded">
                        <h6 class="fw-bold mb-0">
                            <i class="bi @(isPythonVersionManagerExpanded ? "bi-chevron-down" : "bi-chevron-right") me-2"></i>
                            Python Version Manager
                        </h6>
                        <span class="badge bg-secondary">@pythonVersions.Count versions</span>
                    </div>
                    @if (isPythonVersionManagerExpanded)
                    {
                    <table class="table table-sm table-hover mt-2">
                        <thead>
                            <tr>
                                <th>Version</th>
                                <th>Status</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var version in pythonVersions)
                            {
                                <tr>
                                    <td><strong>@version.Version</strong></td>
                                    <td>
                                        @if (version.IsInstalled)
                                        {
                                            <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Installed</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Available</span>
                                        }
                                    </td>
                                    <td>
                                        @if (version.IsInstalled)
                                        {
                                            @if (version.IsActive)
                                            {
                                                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Active</span>
                                            }
                                            else
                                            {
                                                <button class="btn btn-outline-success btn-sm"
                                                        @onclick="() => ShowSetActiveConfirm(version)"
                                                        disabled="@isInstallingVersion">
                                                    <i class="bi bi-check2-circle"></i> Set Active
                                                </button>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (version.IsInstalled)
                                        {
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    @onclick="() => ShowUninstallConfirm(version)"
                                                    disabled="@isInstallingVersion">
                                                <i class="bi bi-trash"></i> Uninstall
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    @onclick="() => ShowInstallConfirm(version)"
                                                    disabled="@isInstallingVersion">
                                                @if (isInstallingVersion && installingVersionName == version.Version)
                                                {
                                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                                }
                                                <i class="bi bi-download"></i> Install
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <button class="btn btn-outline-secondary btn-sm" @onclick="RefreshVersions" disabled="@isRefreshingVersions">
                        @if (isRefreshingVersions)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    }
                </div>
            }
        </div>
    </div>

    <!-- 2. Conversion Engines -->
    <div class="settings-card mb-4">
        <div class="card-header d-flex align-items-center">
            <span class="badge bg-primary me-2">2</span>
            Conversion Engines
            <span class="text-muted small ms-2">(Each engine uses an isolated virtual environment)</span>
        </div>
        <div class="card-body">
            @if (string.IsNullOrEmpty(pythonPath))
            {
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Please configure System Python first (Section 1).
                </div>
            }
            else
            {
                @* Venv Base Path setting *@
                <div class="mb-4 p-3 border rounded bg-light">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div>
                            <h6 class="mb-0"><i class="bi bi-folder-symlink me-2"></i>Virtual Environment Folder</h6>
                            <small class="text-muted">Parent folder for all engine venvs (.venv_markitdown, .venv_docling, .venv_paddle)</small>
                        </div>
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="bi bi-folder"></i></span>
                        <input type="text" class="form-control" @bind="venvBasePath" placeholder="%LOCALAPPDATA%\\MarkBridge" />
                        <button class="btn btn-outline-secondary" @onclick="BrowseVenvBasePath" title="Browse...">
                            <i class="bi bi-folder2-open"></i>
                        </button>
                        <button class="btn btn-outline-primary" @onclick="ApplyVenvBasePath" title="Apply">
                            <i class="bi bi-check-lg"></i> Apply
                        </button>
                    </div>
                </div>

                @* Legacy venv migration warning *@
                @if (AppState.HasLegacyVenv)
                {
                    <div class="alert alert-warning mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                            <strong>Legacy Virtual Environment Detected</strong>
                        </div>
                        <p class="small mb-2">
                            A legacy shared venv was found at: <code>@AppState.LegacyVenvPath</code><br/>
                            This version uses separate venvs for each engine to avoid dependency conflicts.
                        </p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-danger" @onclick="DeleteLegacyVenv">
                                <i class="bi bi-trash me-1"></i>Delete Legacy Venv
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="DismissLegacyVenvWarning">
                                <i class="bi bi-x me-1"></i>Dismiss (keep files)
                            </button>
                        </div>
                    </div>
                }
                <!-- MarkItDown Engine -->
                <div class="engine-card mb-4 p-3 border rounded">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div>
                            <h6 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>MarkItDown</h6>
                            <small class="text-muted">Standard converter, fast and lightweight</small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            @if (markitdownVenvExists && markitdownInstalled)
                            {
                                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Ready v@(markitdownVersion)</span>
                            }
                            else if (markitdownVenvExists)
                            {
                                <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Package not installed</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Not configured</span>
                            }
                        </div>
                    </div>
                    <div class="small text-muted mb-2">
                        <i class="bi bi-folder me-1"></i>
                        <code>@AppState.MarkItDownVenvPath</code>
                    </div>
                    <div class="d-flex gap-2 justify-content-end">
                        @if (!markitdownVenvExists)
                        {
                            <button class="btn btn-success btn-sm" @onclick="SetupMarkItDown" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "markitdown-setup") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-plus-circle me-1"></i>Setup Environment
                            </button>
                        }
                        else if (!markitdownInstalled)
                        {
                            <button class="btn btn-primary btn-sm" @onclick="InstallMarkItDown" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "markitdown") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-download me-1"></i>Install
                            </button>
                            <button class="btn btn-outline-danger btn-sm" @onclick="DeleteMarkItDownVenv" disabled="@isInstalling"><i class="bi bi-trash me-1"></i>Delete</button>
                        }
                        else
                        {
                            <button class="btn btn-outline-secondary btn-sm" @onclick="ReinstallMarkItDown" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "markitdown") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-arrow-clockwise me-1"></i>Reinstall
                            </button>
                            <button class="btn btn-outline-danger btn-sm" @onclick="DeleteMarkItDownVenv" disabled="@isInstalling"><i class="bi bi-trash me-1"></i>Delete</button>
                        }
                    </div>
                </div>
                <!-- Docling Engine -->
                <div class="engine-card mb-4 p-3 border rounded">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div>
                            <h6 class="mb-0"><i class="bi bi-file-earmark-pdf me-2"></i>Docling</h6>
                            <small class="text-muted">Advanced PDF parsing with OCR support (PyTorch)</small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            @if (doclingVenvExists && doclingInstalled)
                            {
                                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Ready v@(doclingVersion)</span>
                                @if (cudaInstalled) 
                                { 
                                    var isNightly = cudaVersion?.StartsWith("12.8") == true || cudaVersion?.StartsWith("12.9") == true;
                                    <span class="badge @(isNightly ? "bg-warning text-dark" : "bg-info")">
                                        <i class="bi bi-gpu-card me-1"></i>CUDA @cudaVersion @(isNightly ? "(Nightly)" : "")
                                    </span>
                                }
                            }
                            else if (doclingVenvExists)
                            {
                                <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Package not installed</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Not configured</span>
                            }
                        </div>
                    </div>
                    <div class="small text-muted mb-2">
                        <i class="bi bi-folder me-1"></i>
                        <code>@AppState.DoclingVenvPath</code>
                    </div>
                    @if (doclingVenvExists && doclingInstalled)
                    {
                        <div class="d-flex justify-content-end mb-2 small gap-3">
                            <span class="@(easyocrInstalled ? "text-success" : "text-muted")"><i class="bi @(easyocrInstalled ? "bi-check-circle-fill" : "bi-circle")"></i> EasyOCR</span>
                            <span class="@(rapidocrInstalled ? "text-success" : "text-muted")"><i class="bi @(rapidocrInstalled ? "bi-check-circle-fill" : "bi-circle")"></i> RapidOCR</span>
                            <span class="@(rapidocrV5Installed ? "text-success" : "text-muted")"><i class="bi @(rapidocrV5Installed ? "bi-star-fill text-warning" : "bi-star")"></i> RapidOCR v5</span>
                            <span class="@(cudaInstalled ? "text-success" : "text-muted")"><i class="bi @(cudaInstalled ? "bi-check-circle-fill" : "bi-circle")"></i> PyTorch CUDA @(cudaVersion ?? "")</span>
                        </div>
                        <div class="d-flex gap-2 flex-wrap mb-2 justify-content-end">
                            <button class="btn btn-outline-secondary btn-sm" @onclick="InstallEasyOcr" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "easyocr") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-download me-1"></i>@(easyocrInstalled ? "Update" : "Add") EasyOCR
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="InstallRapidOcr" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "rapidocr") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-download me-1"></i>@(rapidocrInstalled ? "Update" : "Add") RapidOCR
                            </button>
                            <button class="btn btn-outline-warning btn-sm" @onclick="InstallRapidOcrV5" disabled="@isInstalling" title="PP-OCRv5 models for Japanese">
                                @if (isInstalling && installingPackage == "rapidocr-v5") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-star-fill me-1"></i>@(rapidocrV5Installed ? "Update" : "Add") RapidOCR v5
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="() => InstallCuda(false)" disabled="@isInstalling" title="CUDA 12.4">
                                @if (isInstalling && installingPackage == "cuda") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-gpu-card me-1"></i>@(cudaInstalled ? "Update" : "Add") CUDA
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="() => InstallCuda(true)" disabled="@isInstalling" title="CUDA 12.8 Nightly for RTX 50">
                                @if (isInstalling && installingPackage == "cuda-nightly") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-lightning me-1"></i>RTX 50 Nightly
                            </button>
                        </div>
                    }
                    <div class="d-flex gap-2 justify-content-end">
                        @if (!doclingVenvExists)
                        {
                            <button class="btn btn-outline-secondary btn-sm" @onclick="() => SetupDocling(DoclingMode.Cpu)" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "docling-cpu-setup") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-plus-circle me-1"></i>Setup CPU
                            </button>
                            <button class="btn btn-success btn-sm" @onclick="() => SetupDocling(DoclingMode.Gpu)" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "docling-gpu-setup") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-plus-circle me-1"></i>Setup GPU <span class="badge bg-light text-dark">Recommended</span>
                            </button>
                            <button class="btn btn-outline-warning btn-sm" @onclick="() => SetupDocling(DoclingMode.Nightly)" disabled="@isInstalling" title="CUDA 12.8 Nightly for RTX 50">
                                @if (isInstalling && installingPackage == "docling-nightly-setup") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-lightning me-1"></i>Nightly
                            </button>
                        }
                        else if (!doclingInstalled)
                        {
                            <button class="btn btn-outline-secondary btn-sm" @onclick="() => InstallDocling(DoclingMode.Cpu)" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "docling-cpu") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-download me-1"></i>Install CPU
                            </button>
                            <button class="btn btn-primary btn-sm" @onclick="() => InstallDocling(DoclingMode.Gpu)" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "docling-gpu") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-download me-1"></i>Install GPU
                            </button>
                            <button class="btn btn-outline-warning btn-sm" @onclick="() => InstallDocling(DoclingMode.Nightly)" disabled="@isInstalling" title="CUDA 12.8 Nightly for RTX 50">
                                @if (isInstalling && installingPackage == "docling-nightly") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-lightning me-1"></i>Nightly
                            </button>
                            <button class="btn btn-outline-danger btn-sm" @onclick="DeleteDoclingVenv" disabled="@isInstalling"><i class="bi bi-trash me-1"></i>Delete</button>
                        }
                        else
                        {
                            <button class="btn btn-outline-secondary btn-sm" @onclick="ReinstallDocling" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "docling") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-arrow-clockwise me-1"></i>Reinstall
                            </button>
                            <button class="btn btn-outline-danger btn-sm" @onclick="DeleteDoclingVenv" disabled="@isInstalling"><i class="bi bi-trash me-1"></i>Delete</button>
                        }
                    </div>
                </div>
                <!-- PaddleOCR Engine -->
                <div class="engine-card p-3 border rounded">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div>
                            <h6 class="mb-0"><i class="bi bi-grid-3x3 me-2"></i>PaddleOCR</h6>
                            <small class="text-muted">PP-Structure - Layout analysis and table recognition</small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            @if (paddleVenvExists && paddleOcrInstalled)
                            {
                                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Ready v@(paddleOcrVersion)</span>
                                @if (paddleGpuInstalled) { <span class="badge bg-info"><i class="bi bi-gpu-card me-1"></i>GPU</span> }
                                else if (paddleCpuInstalled) { <span class="badge bg-secondary">CPU</span> }
                            }
                            else if (paddleVenvExists)
                            {
                                <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Package not installed</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Not configured</span>
                            }
                        </div>
                    </div>
                    <div class="small text-muted mb-2">
                        <i class="bi bi-folder me-1"></i>
                        <code>@AppState.PaddleVenvPath</code>
                        <i class="bi bi-info-circle ms-2" title="Isolated to avoid CUDA conflicts"></i>
                    </div>
                    <div class="d-flex gap-2 justify-content-end">
                        @if (!paddleVenvExists)
                        {
                            <button class="btn btn-outline-secondary btn-sm" @onclick="SetupPaddleCpu" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "paddle-cpu-setup") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-plus-circle me-1"></i>Setup CPU
                            </button>
                            <button class="btn btn-success btn-sm" @onclick="SetupPaddleGpu" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "paddle-gpu-setup") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-plus-circle me-1"></i>Setup GPU <span class="badge bg-light text-dark">Recommended</span>
                            </button>
                        }
                        else if (!paddleOcrInstalled)
                        {
                            <button class="btn btn-outline-secondary btn-sm" @onclick="InstallPaddleOcrCpu" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "paddleocr-cpu") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-download me-1"></i>Install CPU
                            </button>
                            <button class="btn btn-primary btn-sm" @onclick="InstallPaddleOcrGpu" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "paddleocr-gpu") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-download me-1"></i>Install GPU
                            </button>
                            <button class="btn btn-outline-danger btn-sm" @onclick="DeletePaddleVenv" disabled="@isInstalling"><i class="bi bi-trash me-1"></i>Delete</button>
                        }
                        else if (paddleCpuInstalled && !paddleGpuInstalled)
                        {
                            <button class="btn btn-success btn-sm" @onclick="SwitchToGpuVersion" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "paddleocr-switch-gpu") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-arrow-up-circle me-1"></i>Upgrade GPU
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="InstallPaddleOcrCpu" disabled="@isInstalling"><i class="bi bi-arrow-clockwise me-1"></i>Update</button>
                            <button class="btn btn-outline-danger btn-sm" @onclick="DeletePaddleVenv" disabled="@isInstalling"><i class="bi bi-trash me-1"></i>Delete</button>
                        }
                        else if (paddleGpuInstalled)
                        {
                            <button class="btn btn-outline-secondary btn-sm" @onclick="SwitchToCpuVersion" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "paddleocr-switch-cpu") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-arrow-down-circle me-1"></i>CPU Only
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="InstallPaddleOcrGpu" disabled="@isInstalling"><i class="bi bi-arrow-clockwise me-1"></i>Update</button>
                            <button class="btn btn-outline-danger btn-sm" @onclick="DeletePaddleVenv" disabled="@isInstalling"><i class="bi bi-trash me-1"></i>Delete</button>
                        }
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(installLog))
                {
                    <div class="mt-3">
                        <label class="form-label d-flex justify-content-between">
                            <span>Installation Log:</span>
                            <button class="btn btn-sm btn-link p-0" @onclick="() => installLog = string.Empty">Clear</button>
                        </label>
                        <pre class="bg-dark text-light p-2 rounded" style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;">@installLog</pre>
                    </div>
                }
            }
        </div>
    </div>
    
    <!-- Advanced Engines (Marker) -->
    <div class="settings-card mb-4">
        <div class="card-header d-flex align-items-center" style="cursor: pointer;" @onclick="() => isAdvancedEnginesExpanded = !isAdvancedEnginesExpanded">
            <i class="bi @(isAdvancedEnginesExpanded ? "bi-chevron-down" : "bi-chevron-right") me-2"></i>
            <span class="badge bg-warning text-dark me-2">Advanced</span>
            Additional Conversion Engines
        </div>
        @if (isAdvancedEnginesExpanded)
        {
        <div class="card-body">
            <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Advanced engines may have additional license requirements.</strong>
                Please review the license terms before enabling.
            </div>
            
            <!-- Marker Engine -->
            <div class="engine-card p-3 border rounded">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div>
                        <h6 class="mb-0"><i class="bi bi-file-earmark-pdf me-2"></i>Marker</h6>
                        <small class="text-muted">High-accuracy PDF to Markdown converter with excellent table support</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        @if (!AppState.MarkerLicenseAccepted)
                        {
                            <span class="badge bg-secondary"><i class="bi bi-lock me-1"></i>License Required</span>
                        }
                        else if (markerVenvExists && markerInstalled)
                        {
                            <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Ready v@(markerVersion)</span>
                        }
                        else if (markerVenvExists)
                        {
                            <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Package not installed</span>
                        }
                        else if (AppState.MarkerLicenseAccepted)
                        {
                            <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Not configured</span>
                        }
                    </div>
                </div>
                <div class="small text-muted mb-2">
                    <i class="bi bi-folder me-1"></i>
                    <code>@AppState.MarkerVenvPath</code>
                </div>
                
                @if (!AppState.MarkerLicenseAccepted)
                {
                    <div class="alert alert-info mb-2">
                        <strong>Marker License Terms:</strong>
                        <ul class="mb-2 mt-2">
                            <li><strong>Code:</strong> GPL License</li>
                            <li><strong>Models:</strong> AI Pubs Open Rail-M (modified)</li>
                        </ul>
                        <strong>Free for:</strong> Research, personal use, startups (revenue/funding &lt; $2M)
                        <br/>
                        <strong>Commercial license required:</strong> Revenue/funding &gt; $5M
                        <br/>
                        <small class="text-muted">Contact: marker@vikas.sh</small>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="markerLicenseCheck" @bind="markerLicenseAgreed">
                        <label class="form-check-label" for="markerLicenseCheck">
                            I understand the license terms and accept responsibility for compliance
                        </label>
                    </div>
                    <button class="btn btn-primary btn-sm" @onclick="AcceptMarkerLicense" disabled="@(!markerLicenseAgreed)">
                        <i class="bi bi-check-circle me-1"></i>Accept and Enable Marker
                    </button>
                }
                else
                {
                    <div class="d-flex gap-2 justify-content-end">
                        @if (!markerVenvExists)
                        {
                            <button class="btn btn-primary btn-sm" @onclick="SetupMarker" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "marker-setup") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-plus-circle me-1"></i>Setup Marker
                                <span class="badge bg-light text-dark ms-1">~3GB models</span>
                            </button>
                        }
                        else if (!markerInstalled)
                        {
                            <button class="btn btn-primary btn-sm" @onclick="InstallMarker" disabled="@isInstalling">
                                @if (isInstalling && installingPackage == "marker") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-download me-1"></i>Install Marker
                            </button>
                            <button class="btn btn-outline-danger btn-sm" @onclick="DeleteMarkerVenv" disabled="@isInstalling"><i class="bi bi-trash me-1"></i>Delete</button>
                        }
                        else
                        {
                            <button class="btn btn-outline-secondary btn-sm" @onclick="InstallMarker" disabled="@isInstalling"><i class="bi bi-arrow-clockwise me-1"></i>Update</button>
                            @if (!markerCudaInstalled)
                            {
                                <button class="btn btn-success btn-sm" @onclick="InstallMarkerCuda" disabled="@isInstalling">
                                    @if (isInstalling && installingPackage == "marker-cuda") { <span class="spinner-border spinner-border-sm me-1"></span> }
                                    <i class="bi bi-gpu-card me-1"></i>Add GPU (CUDA)
                                </button>
                            }
                            else
                            {
                                <span class="badge bg-info"><i class="bi bi-gpu-card me-1"></i>GPU Ready</span>
                            }
                            <button class="btn btn-outline-danger btn-sm" @onclick="DeleteMarkerVenv" disabled="@isInstalling"><i class="bi bi-trash me-1"></i>Delete</button>
                        }
                    </div>
                }
            </div>
        </div>
        }
    </div>
    <!-- 3. Application Settings -->
    <div class="settings-card">
        <div class="card-header d-flex align-items-center">
            <span class="badge bg-primary me-2">3</span>
            Application Settings
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="autoSave" @bind="AutoSaveEnabled" />
                        <label class="form-check-label" for="autoSave">
                            <i class="bi bi-save me-1"></i> Auto-save in Editor
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><i class="bi bi-translate me-1"></i> Language</label>
                    <select class="form-select" @bind="Language">
                        <option value="en">English</option>
                        <option value="ja">日本語</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><i class="bi bi-palette me-1"></i> Theme</label>
                    <select class="form-select" @bind="Theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label"><i class="bi bi-speedometer2 me-1"></i> Max Concurrent Conversions: @MaxConcurrency</label>
                    <input type="range" class="form-range" min="1" max="8" @bind="MaxConcurrency" />
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
@if (showConfirmDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@confirmDialogTitle</h5>
                    <button type="button" class="btn-close" @onclick="CancelConfirm"></button>
                </div>
                <div class="modal-body">
                    <p>@confirmDialogMessage</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelConfirm">Cancel</button>
                    <button type="button" class="btn @confirmDialogButtonClass" @onclick="ConfirmAction">@confirmDialogButtonText</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // DoclingMode enum for CPU/GPU/Nightly selection
    private enum DoclingMode { Cpu, Gpu, Nightly }
    
    // Python
    private string pythonPath = string.Empty;
    private string pythonStatus = string.Empty;
    private string pythonStatusClass = string.Empty;
    private string pythonStatusIcon = string.Empty;
    private bool isDetecting = false;
    private bool showPythonDownload = false;
    private bool isPythonVersionManagerExpanded = false; // Default: collapsed
    
    // Python Install Manager
    private bool pyInstallerAvailable = false;
    private List<MarkBridge.Services.PythonVersionInfo> pythonVersions = new();
    private bool isInstallingVersion = false;
    private string installingVersionName = "";
    private bool isRefreshingVersions = false;

    // Venv (Legacy - for backward compatibility)
    private string venvPath = string.Empty;
    private bool venvExists = false;
#pragma warning disable CS0414 // Field is assigned but never read (legacy)
    private bool isVenvProcessing = false;
#pragma warning restore CS0414
    private string venvLog = string.Empty;

    // Venv Base Path (Issue #1: unified venv folder management)
    private string venvBasePath = string.Empty;

    // Engine-specific Venv status (paths are now derived from VenvBasePath)
    private bool markitdownVenvExists = false;
    private bool doclingVenvExists = false;
    private bool paddleVenvExists = false;
    private bool markerVenvExists = false;

    // Packages
    private bool markitdownInstalled = false;
    private string? markitdownVersion;
    private bool doclingInstalled = false;
    private string? doclingVersion;
    private bool easyocrInstalled = false;
    private string? easyocrVersion;
    private bool rapidocrInstalled = false;
    private string? rapidocrVersion;
    private bool rapidocrV5Installed = false;
    private string? rapidocrV5Version;
    private bool paddleOcrInstalled = false;
    private string? paddleOcrVersion;
    private bool paddleCpuInstalled = false;
    private bool paddleGpuInstalled = false;
    private bool markerInstalled = false;
    private string? markerVersion;
    private bool markerCudaInstalled = false;
    private bool cudaInstalled = false;
    private string? torchVersion;
    private string? cudaVersion;
    private bool isInstalling = false;
    private string installingPackage = string.Empty;
    private string installLog = string.Empty;
    
    // Marker license
    private bool markerLicenseAgreed = false;
    private bool isAdvancedEnginesExpanded = false;

    // App settings
    private bool autoSaveEnabled;
    private string language = "en";
    private string theme = "light";
    private int maxConcurrency = 3;

    // Confirmation dialog
    private bool showConfirmDialog = false;
    private string confirmDialogTitle = "";
    private string confirmDialogMessage = "";
    private string confirmDialogButtonText = "Confirm";
    private string confirmDialogButtonClass = "btn-primary";
    private Func<Task>? pendingConfirmAction;

    private Action? _stateHandler;


    protected override async Task OnInitializedAsync()
    {
        _stateHandler = async () => await InvokeAsync(StateHasChanged);
        AppState.OnChange += _stateHandler;

        // Ensure settings are loaded first
        await AppState.InitializeAsync();

        // Load current settings
        pythonPath = AppState.SystemPythonPath;
        venvBasePath = AppState.VenvBasePath;  // Load venv base path
        autoSaveEnabled = AppState.AutoSaveEnabled;
        language = AppState.Language;
        theme = AppState.Theme;
        maxConcurrency = AppState.MaxConcurrency;

        // Check current state
        await CheckPythonStatus();
        await CheckVenvStatus();
        
        // Check Python Install Manager availability
        pyInstallerAvailable = await PythonEnv.IsPyInstallerAvailableAsync();
        if (pyInstallerAvailable)
        {
            await RefreshVersions();
        }
        // Load engine-specific venv paths (paths are now derived from VenvBasePath)
        // (No longer need to load individual paths)

        // Check engine venv status
        await CheckEngineVenvStatus();

        // Auto-detect installed packages
        await CheckInstalledPackages();
    }

    #region Python Methods

    private async Task AutoDetectPython()
    {
        isDetecting = true;
        pythonStatus = "Detecting Python...";
        pythonStatusClass = "status-processing";
        pythonStatusIcon = "bi-hourglass-split";
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.AutoDetectPythonAsync());

        if (result.found)
        {
            pythonPath = result.path;
            AppState.SystemPythonPath = result.path;
            AppState.PythonVersion = result.version;
            pythonStatus = $"Python {result.version} found.";
            pythonStatusClass = "status-ready";
            pythonStatusIcon = "bi-check-circle-fill";
            showPythonDownload = false;
        }
        else
        {
            pythonStatus = "Python not found.";
            pythonStatusClass = "status-error";
            pythonStatusIcon = "bi-x-circle-fill";
            showPythonDownload = true;
        }

        isDetecting = false;
        StateHasChanged();
    }

    private async Task BrowsePython()
    {
        try
        {
            var options = new PickOptions
            {
                PickerTitle = "Select python.exe",
                FileTypes = new FilePickerFileType(new Dictionary<DevicePlatform, IEnumerable<string>>
                {
                    { DevicePlatform.WinUI, new[] { ".exe" } }
                })
            };

            var result = await FilePicker.Default.PickAsync(options);
            if (result != null)
            {
                pythonPath = result.FullPath;
                await CheckPythonStatus();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"FilePicker error: {ex.Message}");
        }
    }

    private async Task CheckPythonStatus()
    {
        if (string.IsNullOrEmpty(pythonPath))
        {
            pythonStatus = "No Python path configured.";
            pythonStatusClass = "status-warning";
            pythonStatusIcon = "bi-exclamation-triangle";
            showPythonDownload = true;
            return;
        }

        var result = await Task.Run(() => PythonEnv.ValidatePythonAsync(pythonPath));
        if (result.isValid)
        {
            pythonPath = result.fullPath;
            AppState.SystemPythonPath = result.fullPath;
            AppState.PythonVersion = result.version;
            pythonStatus = $"Python {result.version} found.";
            pythonStatusClass = "status-ready";
            pythonStatusIcon = "bi-check-circle-fill";
            showPythonDownload = false;
        }
        else
        {
            pythonStatus = "Invalid Python path or version < 3.10.";
            pythonStatusClass = "status-error";
            pythonStatusIcon = "bi-x-circle-fill";
            showPythonDownload = true;
        }
    }

    #endregion

    #region Python Install Manager

    private async Task RefreshVersions()
    {
        isRefreshingVersions = true;
        StateHasChanged();

        try
        {
            var installedVersions = await PythonEnv.GetInstalledVersionsAsync();
            var availableVersions = PythonEnv.GetAvailableVersions();

            // Merge installed and available versions
            pythonVersions.Clear();

            foreach (var av in availableVersions)
            {
                var installed = installedVersions.FirstOrDefault(iv => iv.Version.StartsWith(av));
                if (installed != null)
                {
                    pythonVersions.Add(installed);
                }
                else
                {
                    pythonVersions.Add(new MarkBridge.Services.PythonVersionInfo
                    {
                        Version = av,
                        Tag = av,  // Available versions have same Version and Tag
                        IsInstalled = false,
                        IsActive = false
                    });
                }
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"RefreshVersions error: {ex.Message}");
        }
        finally
        {
            isRefreshingVersions = false;
            StateHasChanged();
        }
    }

    private async Task InstallPythonVersion(string version)
    {
        isInstallingVersion = true;
        installingVersionName = version;
        StateHasChanged();

        try
        {
            var result = await PythonEnv.InstallPythonVersionAsync(version, msg =>
            {
                venvLog = msg;
                InvokeAsync(StateHasChanged);
            });

            if (result.success)
            {
                await RefreshVersions();
            }
        }
        finally
        {
            isInstallingVersion = false;
            installingVersionName = "";
            StateHasChanged();
        }
    }

    private void ShowUninstallConfirm(MarkBridge.Services.PythonVersionInfo version)
    {
        confirmDialogTitle = "Uninstall Python";
        confirmDialogMessage = $"Are you sure you want to uninstall Python {version.Version}?";
        confirmDialogButtonText = "Uninstall";
        confirmDialogButtonClass = "btn-danger";
        pendingConfirmAction = async () =>
        {
            isInstallingVersion = true;
            installingVersionName = version.Version;
            StateHasChanged();

            var result = await PythonEnv.UninstallPythonVersionAsync(version.Tag, msg =>
            {
                venvLog = msg;
                InvokeAsync(StateHasChanged);
            });

            await RefreshVersions();
            isInstallingVersion = false;
            installingVersionName = "";
            StateHasChanged();
        };
        showConfirmDialog = true;
        StateHasChanged();
    }

    private void ShowInstallConfirm(MarkBridge.Services.PythonVersionInfo version)
    {
        confirmDialogTitle = "Install Python";
        confirmDialogMessage = $"Do you want to install Python {version.Version}?";
        confirmDialogButtonText = "Install";
        confirmDialogButtonClass = "btn-primary";
        pendingConfirmAction = async () =>
        {
            isInstallingVersion = true;
            installingVersionName = version.Version;
            StateHasChanged();

            var result = await PythonEnv.InstallPythonVersionAsync(version.Tag, msg =>
            {
                venvLog = msg;
                InvokeAsync(StateHasChanged);
            });

            await RefreshVersions();
            isInstallingVersion = false;
            installingVersionName = "";
            StateHasChanged();
        };
        showConfirmDialog = true;
        StateHasChanged();
    }

    private void ShowSetActiveConfirm(MarkBridge.Services.PythonVersionInfo version)
    {
        confirmDialogTitle = "Set Active Python";
        confirmDialogMessage = $"Do you want to set Python {version.Version} as the active version?";
        confirmDialogButtonText = "Set Active";
        confirmDialogButtonClass = "btn-success";
        pendingConfirmAction = async () =>
        {
            isInstallingVersion = true;
            StateHasChanged();

            var result = await PythonEnv.SetActiveVersionAsync(version.Tag);
            
            if (result.success)
            {
                foreach (var v in pythonVersions)
                {
                    v.IsActive = false;
                }
                version.IsActive = true;
                
                pythonPath = AppState.SystemPythonPath;
                await CheckPythonStatus();
            }

            isInstallingVersion = false;
            StateHasChanged();
        };
        showConfirmDialog = true;
        StateHasChanged();
    }

    #endregion

    #region Venv Methods

    private async Task CheckVenvStatus()
    {
        // Redirect to engine-specific check
        await CheckEngineVenvStatus();
        
        // Also check legacy venv path for backward compatibility
        if (string.IsNullOrEmpty(venvPath))
        {
            venvPath = AppState.MarkItDownVenvPath; // Use MarkItDown as default
        }
        venvExists = PythonEnv.IsVenvValid(venvPath);

        if (venvExists)
        {
            await CheckInstalledPackages();
        }

        StateHasChanged();
    }

    private async Task CheckEngineVenvStatus()
    {
        // Use paths derived from VenvBasePath
        markitdownVenvExists = PythonEnv.IsVenvValid(AppState.MarkItDownVenvPath);
        doclingVenvExists = PythonEnv.IsVenvValid(AppState.DoclingVenvPath);
        paddleVenvExists = PythonEnv.IsVenvValid(AppState.PaddleVenvPath);
        
        AppState.IsMarkItDownVenvActive = markitdownVenvExists;
        AppState.IsDoclingVenvActive = doclingVenvExists;
        AppState.IsPaddleVenvActive = paddleVenvExists;
        
        await Task.CompletedTask;
    }

    #region Venv Base Path Methods

    private async Task BrowseVenvBasePath()
    {
        try
        {
            var result = await FolderPicker.Default.PickAsync();
            if (result.IsSuccessful)
            {
                venvBasePath = result.Folder.Path;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"FolderPicker error: {ex.Message}");
        }
    }

    private async Task ApplyVenvBasePath()
    {
        if (string.IsNullOrWhiteSpace(venvBasePath))
        {
            return;
        }

        AppState.VenvBasePath = venvBasePath;
        await CheckEngineVenvStatus();
        await CheckInstalledPackages();
        StateHasChanged();
    }

    #endregion

    #region Legacy Venv Migration

    private Task DeleteLegacyVenv()
    {
        ShowConfirmDialog(
            "Delete Legacy Virtual Environment",
            $"Are you sure you want to delete the legacy venv at:\n{AppState.LegacyVenvPath}\n\nThis action cannot be undone.",
            "Delete",
            "btn-danger",
            async () =>
            {
                installLog = "=== Deleting Legacy Venv ===\n";
                StateHasChanged();

                var result = await Task.Run(() => PythonEnv.DeleteVenv(AppState.LegacyVenvPath));
                installLog += result.message + "\n";

                // Clear legacy path from settings
                AppState.ClearLegacyVenv();
                
                installLog += "Legacy venv path cleared from settings.\n";
                StateHasChanged();
            });
        return Task.CompletedTask;
    }

    private void DismissLegacyVenvWarning()
    {
        // Clear legacy path from settings without deleting files
        AppState.ClearLegacyVenv();
        StateHasChanged();
    }

    #endregion

    #region Engine Setup Methods

    private async Task SetupMarkItDown()
    {
        isInstalling = true;
        installingPackage = "markitdown-setup";
        installLog = "=== Setting up MarkItDown Environment ===\n";
        AppState.SetStatus("Setting up MarkItDown...", true);
        StateHasChanged();

        try
        {
            installLog += "Creating virtual environment...\n";
            var venvResult = await Task.Run(() => PythonEnv.CreateVenvAsync(pythonPath, AppState.MarkItDownVenvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            if (!venvResult.success)
            {
                installLog += $"Error: {venvResult.message}\n";
                return;
            }

            installLog += "\nInstalling MarkItDown...\n";
            var installResult = await Task.Run(() => PythonEnv.InstallMarkItDownAsync(AppState.MarkItDownVenvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            installLog += $"\n{installResult.message}\n";
        }
        finally
        {
            isInstalling = false;
            installingPackage = string.Empty;
            AppState.SetStatus("Ready");
            await CheckEngineVenvStatus();
            await CheckInstalledPackages();
            StateHasChanged();
        }
    }

    private Task DeleteMarkItDownVenv()
    {
        ShowConfirmDialog(
            "Delete MarkItDown Environment",
            "Are you sure you want to delete the MarkItDown virtual environment?",
            "Delete",
            "btn-danger",
            async () =>
            {
                isInstalling = true;
                StateHasChanged();
                var result = await Task.Run(() => PythonEnv.DeleteVenv(AppState.MarkItDownVenvPath));
                installLog = result.message;
                isInstalling = false;
                await CheckEngineVenvStatus();
                await CheckInstalledPackages();
                StateHasChanged();
            });
        return Task.CompletedTask;
    }

    private async Task ReinstallMarkItDown()
    {
        await Task.Run(() => PythonEnv.DeleteVenv(AppState.MarkItDownVenvPath));
        await SetupMarkItDown();
    }

    private async Task SetupDocling(DoclingMode mode)
    {
        isInstalling = true;
        installingPackage = mode switch
        {
            DoclingMode.Cpu => "docling-cpu-setup",
            DoclingMode.Gpu => "docling-gpu-setup",
            DoclingMode.Nightly => "docling-nightly-setup",
            _ => "docling-setup"
        };
        var modeLabel = mode switch
        {
            DoclingMode.Cpu => "CPU",
            DoclingMode.Gpu => "GPU (CUDA 12.4)",
            DoclingMode.Nightly => "Nightly (CUDA 12.8)",
            _ => ""
        };
        installLog = $"=== Setting up Docling Environment ({modeLabel}) ===\n";
        AppState.SetStatus($"Setting up Docling ({modeLabel})...", true);
        StateHasChanged();

        try
        {
            installLog += "Creating virtual environment...\n";
            var venvResult = await Task.Run(() => PythonEnv.CreateVenvAsync(pythonPath, AppState.DoclingVenvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            if (!venvResult.success)
            {
                installLog += $"Error: {venvResult.message}\n";
                return;
            }

            installLog += "\nInstalling Docling...\n";
            var installResult = await Task.Run(() => PythonEnv.InstallDoclingAsync(AppState.DoclingVenvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            installLog += $"\n{installResult.message}\n";

            // Install PyTorch based on mode
            if (mode == DoclingMode.Gpu || mode == DoclingMode.Nightly)
            {
                bool isNightly = mode == DoclingMode.Nightly;
                installLog += $"\nInstalling PyTorch CUDA ({(isNightly ? "12.8 Nightly" : "12.4")})...\n";
                var cudaResult = await Task.Run(() => PythonEnv.InstallCudaSupportAsync(AppState.DoclingVenvPath, isNightly, log =>
                {
                    installLog += log + "\n";
                    InvokeAsync(StateHasChanged);
                }));
                installLog += $"\n{cudaResult.message}\n";
            }
        }
        finally
        {
            isInstalling = false;
            installingPackage = string.Empty;
            AppState.SetStatus("Ready");
            await CheckEngineVenvStatus();
            await CheckInstalledPackages();
            StateHasChanged();
        }
    }

    private Task DeleteDoclingVenv()
    {
        ShowConfirmDialog(
            "Delete Docling Environment",
            "Are you sure you want to delete the Docling virtual environment?",
            "Delete",
            "btn-danger",
            async () =>
            {
                isInstalling = true;
                StateHasChanged();
                var result = await Task.Run(() => PythonEnv.DeleteVenv(AppState.DoclingVenvPath));
                installLog = result.message;
                isInstalling = false;
                await CheckEngineVenvStatus();
                await CheckInstalledPackages();
                StateHasChanged();
            });
        return Task.CompletedTask;
    }

    private async Task ReinstallDocling()
    {
        await Task.Run(() => PythonEnv.DeleteVenv(AppState.DoclingVenvPath));
        await SetupDocling(DoclingMode.Gpu); // Default to GPU mode for reinstall
    }

    private async Task SetupPaddleCpu() => await SetupPaddle(false);
    private async Task SetupPaddleGpu() => await SetupPaddle(true);

    private async Task SetupPaddle(bool useGpu)
    {
        isInstalling = true;
        installingPackage = useGpu ? "paddle-gpu-setup" : "paddle-cpu-setup";
        installLog = $"=== Setting up PaddleOCR {(useGpu ? "GPU" : "CPU")} Environment ===\n";
        AppState.SetStatus($"Setting up PaddleOCR {(useGpu ? "GPU" : "CPU")}...", true);
        StateHasChanged();

        try
        {
            installLog += "Creating virtual environment...\n";
            var venvResult = await Task.Run(() => PythonEnv.CreateVenvAsync(pythonPath, AppState.PaddleVenvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            if (!venvResult.success)
            {
                installLog += $"Error: {venvResult.message}\n";
                return;
            }

            installLog += $"\nInstalling PaddleOCR {(useGpu ? "GPU" : "CPU")}...\n";
            var installResult = useGpu
                ? await Task.Run(() => PythonEnv.InstallPaddleOcrGpuAsync(AppState.PaddleVenvPath, log =>
                {
                    installLog += log + "\n";
                    InvokeAsync(StateHasChanged);
                }))
                : await Task.Run(() => PythonEnv.InstallPaddleOcrCpuAsync(AppState.PaddleVenvPath, log =>
                {
                    installLog += log + "\n";
                    InvokeAsync(StateHasChanged);
                }));

            installLog += $"\n{installResult.message}\n";
        }
        finally
        {
            isInstalling = false;
            installingPackage = string.Empty;
            AppState.SetStatus("Ready");
            await CheckEngineVenvStatus();
            await CheckInstalledPackages();
            StateHasChanged();
        }
    }

    private Task DeletePaddleVenv()
    {
        ShowConfirmDialog(
            "Delete PaddleOCR Environment",
            "Are you sure you want to delete the PaddleOCR virtual environment?",
            "Delete",
            "btn-danger",
            async () =>
            {
                isInstalling = true;
                StateHasChanged();
                var result = await Task.Run(() => PythonEnv.DeleteVenv(AppState.PaddleVenvPath));
                installLog = result.message;
                isInstalling = false;
                await CheckEngineVenvStatus();
                await CheckInstalledPackages();
                StateHasChanged();
            });
        return Task.CompletedTask;
    }

    // Marker methods
    private void AcceptMarkerLicense()
    {
        AppState.MarkerLicenseAccepted = true;
        StateHasChanged();
    }

    private async Task SetupMarker()
    {
        isInstalling = true;
        installingPackage = "marker-setup";
        installLog = string.Empty;
        AppState.SetStatus("Setting up Marker environment...", true);
        StateHasChanged();

        // Create venv
        var venvResult = await Task.Run(() => PythonEnv.CreateVenvAsync(
            AppState.SystemPythonPath, 
            AppState.MarkerVenvPath, 
            log => { installLog += log + "\n"; InvokeAsync(StateHasChanged); }));

        if (venvResult.success)
        {
            installLog += "\nInstalling Marker (this may take 10-30 minutes for model download)...\n";
            StateHasChanged();
            
            var result = await Task.Run(() => PythonEnv.InstallMarkerAsync(AppState.MarkerVenvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));
            installLog += "\n" + result.message;
        }
        else
        {
            installLog += "\nFailed to create venv: " + venvResult.message;
        }

        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckEngineVenvStatus();
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallMarker()
    {
        isInstalling = true;
        installingPackage = "marker";
        installLog = string.Empty;
        AppState.SetStatus("Installing Marker...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallMarkerAsync(AppState.MarkerVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private Task DeleteMarkerVenv()
    {
        ShowConfirmDialog(
            "Delete Marker Environment",
            "Are you sure you want to delete the Marker virtual environment?",
            "Delete",
            "btn-danger",
            async () =>
            {
                isInstalling = true;
                StateHasChanged();
                var result = await Task.Run(() => PythonEnv.DeleteVenv(AppState.MarkerVenvPath));
                installLog = result.message;
                isInstalling = false;
                markerVenvExists = false;
                markerInstalled = false;
                markerVersion = null;
                await CheckEngineVenvStatus();
                StateHasChanged();
            });
        return Task.CompletedTask;
    }

    private async Task InstallMarkerCuda()
    {
        isInstalling = true;
        installingPackage = "marker-cuda";
        installLog = string.Empty;
        AppState.SetStatus("Installing CUDA support for Marker (Nightly for RTX 50-series)...", true);
        StateHasChanged();

        // Install PyTorch Nightly with CUDA 12.8 (required for RTX 50-series sm_120)
        var result = await Task.Run(() => PythonEnv.InstallCudaSupportAsync(AppState.MarkerVenvPath, true, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        // Downgrade Pillow to compatible version for marker-pdf
        if (result.success)
        {
            installLog += "\nDowngrading Pillow for marker-pdf compatibility...\n";
            await InvokeAsync(StateHasChanged);
            
            var pillowResult = await PythonEnv.RunPipInstallAsync(
                AppState.MarkerVenvPath, 
                "install \"pillow>=10.1.0,<11.0.0\"",
                log => { installLog += log + "\n"; _ = InvokeAsync(StateHasChanged); });
            
            installLog += pillowResult.success ? "\nPillow downgrade completed." : $"\nPillow downgrade failed: {pillowResult.message}";
        }

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    #endregion

    private async Task CreateVenv()
    {
        isVenvProcessing = true;
        venvLog = string.Empty;
        AppState.SetStatus("Creating virtual environment...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.CreateVenvAsync(pythonPath, venvPath, log =>
        {
            venvLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        if (result.success)
        {
            // VenvPath is now derived from VenvBasePath, no need to set individually
            venvLog += "\n" + result.message;
        }
        else
        {
            venvLog += "\nError: " + result.message;
        }

        isVenvProcessing = false;
        AppState.SetStatus("Ready");
        await CheckVenvStatus();
    }

    private async Task RebuildVenv()
    {
        await CreateVenv();
    }

    private Task DeleteVenv()
    {
        ShowConfirmDialog(
            "Delete Virtual Environment",
            "Are you sure you want to delete the virtual environment? This action cannot be undone.",
            "Delete",
            "btn-danger",
            async () =>
            {
                isVenvProcessing = true;
                StateHasChanged();

                var result = await Task.Run(() => PythonEnv.DeleteVenv(venvPath));
                venvLog = result.message;

                isVenvProcessing = false;
                await CheckVenvStatus();
            });
        return Task.CompletedTask;
    }

    private async Task BrowseVenv()
    {
        try
        {
            var result = await FolderPicker.Default.PickAsync();
            if (result.IsSuccessful)
            {
                venvPath = result.Folder.Path;
                await CheckVenvStatus();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"FolderPicker error: {ex.Message}");
        }
    }

    #endregion

    #region Confirmation Dialog

    private void ShowConfirmDialog(string title, string message, string buttonText, string buttonClass, Func<Task> action)
    {
        confirmDialogTitle = title;
        confirmDialogMessage = message;
        confirmDialogButtonText = buttonText;
        confirmDialogButtonClass = buttonClass;
        pendingConfirmAction = action;
        showConfirmDialog = true;
        StateHasChanged();
    }

    private async Task ConfirmAction()
    {
        showConfirmDialog = false;
        if (pendingConfirmAction != null)
        {
            await pendingConfirmAction();
        }
        StateHasChanged();
    }

    private void CancelConfirm()
    {
        showConfirmDialog = false;
        pendingConfirmAction = null;
        StateHasChanged();
    }

    #endregion

    #region Package Installation

    private async Task CheckInstalledPackages()
    {
        // MarkItDown - uses AppState.MarkItDownVenvPath
        var markitdown = await PythonEnv.CheckMarkItDownAsync(AppState.MarkItDownVenvPath);
        markitdownInstalled = markitdown.installed;
        markitdownVersion = markitdown.version;
        AppState.MarkItDownVersion = markitdown.version;

        // Docling and OCR engines - uses AppState.DoclingVenvPath
        var docling = await PythonEnv.CheckDoclingAsync(AppState.DoclingVenvPath);
        doclingInstalled = docling.installed;
        doclingVersion = docling.version;
        AppState.DoclingVersion = docling.version;

        var easyocr = await PythonEnv.CheckEasyOcrAsync(AppState.DoclingVenvPath);
        easyocrInstalled = easyocr.installed;
        easyocrVersion = easyocr.version;

        var rapidocr = await PythonEnv.CheckRapidOcrAsync(AppState.DoclingVenvPath);
        rapidocrInstalled = rapidocr.installed;
        rapidocrVersion = rapidocr.version;

        var rapidocrv5 = await PythonEnv.CheckRapidOcrV5Async(AppState.DoclingVenvPath);
        rapidocrV5Installed = rapidocrv5.installed;
        rapidocrV5Version = rapidocrv5.version;

        var cuda = await PythonEnv.CheckCudaAsync(AppState.DoclingVenvPath);
        cudaInstalled = cuda.installed;
        torchVersion = cuda.torchVersion;
        cudaVersion = cuda.cudaVersion;

        // PaddleOCR - uses AppState.PaddleVenvPath
        var paddle = await PythonEnv.CheckPaddleOcrAsync(AppState.PaddleVenvPath);
        paddleOcrInstalled = paddle.installed;
        paddleOcrVersion = paddle.version;

        var paddleCpu = await PythonEnv.CheckPaddleCpuAsync(AppState.PaddleVenvPath);
        paddleCpuInstalled = paddleCpu.installed;

        var paddleGpu = await PythonEnv.CheckPaddleGpuAsync(AppState.PaddleVenvPath);
        paddleGpuInstalled = paddleGpu.installed;
        
        // Marker - uses AppState.MarkerVenvPath
        markerVenvExists = PythonEnv.IsVenvValid(AppState.MarkerVenvPath);
        if (markerVenvExists)
        {
            var marker = await PythonEnv.CheckMarkerAsync(AppState.MarkerVenvPath);
            markerInstalled = marker.installed;
            markerVersion = marker.version;
            
            // Check if CUDA is installed for Marker
            var markerCuda = await PythonEnv.CheckCudaAsync(AppState.MarkerVenvPath);
            markerCudaInstalled = markerCuda.installed;
        }
    }

    private async Task InstallMarkItDown()
    {
        isInstalling = true;
        installingPackage = "markitdown";
        installLog = string.Empty;
        AppState.SetStatus("Installing MarkItDown...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallMarkItDownAsync(AppState.MarkItDownVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallDocling(DoclingMode mode)
    {
        isInstalling = true;
        installingPackage = mode switch
        {
            DoclingMode.Cpu => "docling-cpu",
            DoclingMode.Gpu => "docling-gpu",
            DoclingMode.Nightly => "docling-nightly",
            _ => "docling"
        };
        var modeLabel = mode switch
        {
            DoclingMode.Cpu => "CPU",
            DoclingMode.Gpu => "GPU (CUDA 12.4)",
            DoclingMode.Nightly => "Nightly (CUDA 12.8)",
            _ => ""
        };
        installLog = $"=== Installing Docling ({modeLabel}) ===\n";
        AppState.SetStatus($"Installing Docling ({modeLabel})...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallDoclingAsync(AppState.DoclingVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;

        // Install PyTorch based on mode
        if (mode == DoclingMode.Gpu || mode == DoclingMode.Nightly)
        {
            bool isNightly = mode == DoclingMode.Nightly;
            installLog += $"\nInstalling PyTorch CUDA ({(isNightly ? "12.8 Nightly" : "12.4")})...\n";
            var cudaResult = await Task.Run(() => PythonEnv.InstallCudaSupportAsync(AppState.DoclingVenvPath, isNightly, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));
            installLog += $"\n{cudaResult.message}\n";
        }

        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallEasyOcr()
    {
        isInstalling = true;
        installingPackage = "easyocr";
        installLog = string.Empty;
        AppState.SetStatus("Installing EasyOCR...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallEasyOcrAsync(AppState.DoclingVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }
    private async Task InstallRapidOcr()
    {
        isInstalling = true;
        installingPackage = "rapidocr";
        installLog = string.Empty;
        AppState.SetStatus("Installing RapidOCR...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallRapidOcrAsync(AppState.DoclingVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallRapidOcrV5()
    {
        isInstalling = true;
        installingPackage = "rapidocr-v5";
        installLog = string.Empty;
        AppState.SetStatus("Installing RapidOCR v5 (PP-OCRv5)...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallRapidOcrV5Async(AppState.DoclingVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallPaddleOcrCpu()
    {
        isInstalling = true;
        installingPackage = "paddleocr-cpu";
        installLog = string.Empty;
        AppState.SetStatus("Installing PaddleOCR (CPU)...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallPaddleOcrCpuAsync(AppState.PaddleVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallPaddleOcrGpu()
    {
        isInstalling = true;
        installingPackage = "paddleocr-gpu";
        installLog = string.Empty;
        AppState.SetStatus("Installing PaddleOCR (GPU)...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallPaddleOcrGpuAsync(AppState.PaddleVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task InstallCuda(bool useNightly)
    {
        isInstalling = true;
        installingPackage = useNightly ? "cuda-nightly" : "cuda";
        installLog = string.Empty;
        AppState.SetStatus("Installing CUDA support...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.InstallCudaSupportAsync(AppState.DoclingVenvPath, useNightly, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        StateHasChanged();
    }

    private async Task InstallAllPackages()
    {
        isInstalling = true;
        installingPackage = "all";
        installLog = string.Empty;
        AppState.SetStatus("Installing all packages...", true);
        StateHasChanged();

        var packages = new List<(string name, Func<string, Action<string>?, Task<(bool success, string message)>> installer)>
        {
            ("MarkItDown", (venv, log) => PythonEnv.InstallMarkItDownAsync(venv, log)),
            ("Docling", (venv, log) => PythonEnv.InstallDoclingAsync(venv, log)),
            ("EasyOCR", (venv, log) => PythonEnv.InstallEasyOcrAsync(venv, log)),
            ("RapidOCR", (venv, log) => PythonEnv.InstallRapidOcrAsync(venv, log)),
            ("PaddleOCR (CPU)", (venv, log) => PythonEnv.InstallPaddleOcrCpuAsync(venv, log)),
        };

        int successCount = 0;
        int failCount = 0;

        foreach (var (name, installer) in packages)
        {
            installLog += $"\n=== Installing {name} ===\n";
            await InvokeAsync(StateHasChanged);

            var result = await Task.Run(() => installer(venvPath, log =>
            {
                installLog += log + "\n";
                InvokeAsync(StateHasChanged);
            }));

            if (result.success)
            {
                successCount++;
                installLog += $"✁E{name} installed successfully.\n";
            }
            else
            {
                failCount++;
                installLog += $"✁E{name} failed: {result.message}\n";
            }
            await InvokeAsync(StateHasChanged);
        }

        installLog += $"\n=== Complete: {successCount} succeeded, {failCount} failed ===\n";
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    #endregion

    #region Package Uninstall

    private async Task UninstallMarkItDown()
    {
        isInstalling = true;
        installingPackage = "markitdown";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling MarkItDown...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallMarkItDownAsync(AppState.MarkItDownVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task UninstallDocling()
    {
        isInstalling = true;
        installingPackage = "docling";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling Docling...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallDoclingAsync(AppState.DoclingVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task UninstallEasyOcr()
    {
        isInstalling = true;
        installingPackage = "easyocr";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling EasyOCR...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallEasyOcrAsync(AppState.DoclingVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task UninstallRapidOcr()
    {
        isInstalling = true;
        installingPackage = "rapidocr";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling RapidOCR...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallRapidOcrAsync(AppState.DoclingVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task UninstallPaddleOcrCpu()
    {
        isInstalling = true;
        installingPackage = "paddleocr-cpu";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling PaddleOCR (CPU)...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallPaddleOcrCpuAsync(AppState.PaddleVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    private async Task UninstallPaddleOcrGpu()
    {
        isInstalling = true;
        installingPackage = "paddleocr-gpu";
        installLog = string.Empty;
        AppState.SetStatus("Uninstalling PaddleOCR (GPU)...", true);
        StateHasChanged();

        var result = await Task.Run(() => PythonEnv.UninstallPaddleOcrGpuAsync(AppState.PaddleVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));

        installLog += "\n" + result.message;
        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    /// <summary>
    /// Unified uninstall for PaddleOCR (both CPU and GPU)
    /// </summary>
    private async Task UninstallPaddleOcr()
    {
        if (paddleGpuInstalled)
        {
            await UninstallPaddleOcrGpu();
        }
        else if (paddleCpuInstalled)
        {
            await UninstallPaddleOcrCpu();
        }
    }

    /// <summary>
    /// Switch from CPU to GPU version (uninstall CPU, install GPU)
    /// </summary>
    private async Task SwitchToGpuVersion()
    {
        isInstalling = true;
        installingPackage = "paddleocr-switch-gpu";
        installLog = string.Empty;
        AppState.SetStatus("Switching to GPU version...", true);
        StateHasChanged();

        // First uninstall CPU version
        installLog += "=== Uninstalling CPU version ===\n";
        var uninstallResult = await Task.Run(() => PythonEnv.UninstallPaddleOcrCpuAsync(AppState.PaddleVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));
        installLog += uninstallResult.message + "\n\n";

        // Then install GPU version
        installLog += "=== Installing GPU version ===\n";
        var installResult = await Task.Run(() => PythonEnv.InstallPaddleOcrGpuAsync(AppState.PaddleVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));
        installLog += "\n" + installResult.message;

        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    /// <summary>
    /// Switch from GPU to CPU version (uninstall GPU, install CPU)
    /// </summary>
    private async Task SwitchToCpuVersion()
    {
        isInstalling = true;
        installingPackage = "paddleocr-switch-cpu";
        installLog = string.Empty;
        AppState.SetStatus("Switching to CPU version...", true);
        StateHasChanged();

        // First uninstall GPU version
        installLog += "=== Uninstalling GPU version ===\n";
        var uninstallResult = await Task.Run(() => PythonEnv.UninstallPaddleOcrGpuAsync(AppState.PaddleVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));
        installLog += uninstallResult.message + "\n\n";

        // Then install CPU version
        installLog += "=== Installing CPU version ===\n";
        var installResult = await Task.Run(() => PythonEnv.InstallPaddleOcrCpuAsync(AppState.PaddleVenvPath, log =>
        {
            installLog += log + "\n";
            InvokeAsync(StateHasChanged);
        }));
        installLog += "\n" + installResult.message;

        isInstalling = false;
        installingPackage = string.Empty;
        AppState.SetStatus("Ready");
        await CheckInstalledPackages();
        StateHasChanged();
    }

    #endregion

    #region App Settings

    private bool AutoSaveEnabled
    {
        get => autoSaveEnabled;
        set
        {
            autoSaveEnabled = value;
            AppState.AutoSaveEnabled = value;
        }
    }

    private string Language
    {
        get => language;
        set
        {
            language = value;
            AppState.Language = value;
        }
    }

    private string Theme
    {
        get => theme;
        set
        {
            theme = value;
            AppState.Theme = value;
            _ = JS.InvokeVoidAsync("setTheme", value);
        }
    }

    private int MaxConcurrency
    {
        get => maxConcurrency;
        set
        {
            maxConcurrency = value;
            AppState.MaxConcurrency = value;
        }
    }

    #endregion

    public void Dispose()
    {
        if (_stateHandler != null)
        {
            AppState.OnChange -= _stateHandler;
        }
    }
}
