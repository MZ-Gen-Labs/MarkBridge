@page "/dragdroptest"
@inject IJSRuntime JS

<h3>Drag & Drop Test Page</h3>
<p>このページは2つのD&D実装方式をテストするためのものです。</p>

<div class="row">
    <!-- 方式1: HTML5 Blazor D&D (現在の実装) -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                方式1: HTML5 Blazor D&D
            </div>
            <div class="card-body">
                <div class="drop-zone p-4 text-center border border-dashed rounded @(isDragOver1 ? "bg-light" : "")"
                     style="min-height: 150px; border-style: dashed !important;"
                     @ondragover="() => isDragOver1 = true"
                     @ondragover:preventDefault
                     @ondragleave="() => isDragOver1 = false"
                     @ondrop="HandleDrop1"
                     @ondrop:preventDefault>
                    <i class="bi bi-cloud-upload display-4 text-muted"></i>
                    <p class="mt-2">Drop files here (HTML5)</p>
                </div>
                <div class="mt-3">
                    <strong>Results:</strong>
                    <pre class="bg-light p-2 mt-2" style="max-height: 200px; overflow-y: auto;">@result1</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- 方式2: JavaScript Interop -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                方式2: JavaScript Interop
            </div>
            <div class="card-body">
                <div id="jsDropZone" 
                     class="drop-zone p-4 text-center border border-dashed rounded"
                     style="min-height: 150px; border-style: dashed !important;">
                    <i class="bi bi-cloud-upload display-4 text-muted"></i>
                    <p class="mt-2">Drop files here (JS Interop)</p>
                </div>
                <div class="mt-3">
                    <strong>Results:</strong>
                    <pre class="bg-light p-2 mt-2" style="max-height: 200px; overflow-y: auto;">@result2</pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 方式3: FilePicker (ボタン経由) -->
<div class="card mt-4">
    <div class="card-header bg-warning">
        方式3: FilePicker (代替案)
    </div>
    <div class="card-body">
        <button class="btn btn-warning" @onclick="OpenFilePicker">
            <i class="bi bi-folder2-open me-2"></i>Select Files
        </button>
        <div class="mt-3">
            <strong>Results:</strong>
            <pre class="bg-light p-2 mt-2" style="max-height: 200px; overflow-y: auto;">@result3</pre>
        </div>
    </div>
</div>

<!-- 方式4: MAUI DropGestureRecognizer (ネイティブ層) -->
<div class="card mt-4">
    <div class="card-header bg-danger text-white">
        方式4: MAUI DropGestureRecognizer (ネイティブ層)
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <strong>テスト方法:</strong> ウィンドウ全体の<strong>どこにでも</strong>ファイルをドロップしてください。
            <br/>ネイティブMAUI層がドロップを受け取り、ここに結果を表示します。
        </div>
        <div class="mt-3">
            <strong>Results:</strong>
            <pre class="bg-light p-2 mt-2" style="max-height: 200px; overflow-y: auto;">@result4</pre>
        </div>
    </div>
</div>

<div class="alert alert-info mt-4">
    <strong>テスト手順:</strong>
    <ol>
        <li>エクスプローラーからファイルをドラッグして各ゾーンにドロップ</li>
        <li>結果欄にファイルパスが表示されるか確認</li>
        <li>エラーが発生する場合はその内容を確認</li>
    </ol>
</div>

@code {
    private bool isDragOver1 = false;
    private string result1 = "Waiting for drop...";
    private string result2 = "Waiting for drop...";
    private string result3 = "Click button to select files...";
    private string result4 = "Waiting for drop anywhere in window...";

    private DotNetObjectReference<DragDropTest>? dotNetRef;

    protected override void OnInitialized()
    {
        // Subscribe to MAUI native drop events
        MainPage.OnFilesDropped += HandleMauiDrop;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("setupJsDropZone", "jsDropZone", dotNetRef);
        }
    }

    // 方式4: MAUI DropGestureRecognizer からの通知
    private void HandleMauiDrop(List<string> filePaths)
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine($"[{DateTime.Now:HH:mm:ss}] MAUI Native Drop detected!");
        sb.AppendLine($"Files count: {filePaths.Count}");
        
        if (filePaths.Count > 0)
        {
            sb.AppendLine("\nFile paths:");
            foreach (var path in filePaths)
            {
                sb.AppendLine($"  ✅ {path}");
            }
        }
        else
        {
            sb.AppendLine("\n⚠️ No file paths received");
        }
        
        result4 = sb.ToString();
        InvokeAsync(StateHasChanged);
    }

    // 方式1: HTML5 Blazor D&D
    private Task HandleDrop1(DragEventArgs e)
    {
        isDragOver1 = false;
        
        try
        {
            // DataTransfer からファイル情報取得を試みる
            var items = e.DataTransfer?.Items;
            var files = e.DataTransfer?.Files;
            var types = e.DataTransfer?.Types;
            
            var sb = new System.Text.StringBuilder();
            sb.AppendLine($"[{DateTime.Now:HH:mm:ss}] Drop detected!");
            sb.AppendLine($"Items count: {items?.Length ?? 0}");
            sb.AppendLine($"Files count: {files?.Length ?? 0}");
            sb.AppendLine($"Types: {string.Join(", ", types ?? Array.Empty<string>())}");
            
            if (files != null && files.Length > 0)
            {
                sb.AppendLine("\nFiles:");
                foreach (var file in files)
                {
                    sb.AppendLine($"  - {file}");
                }
            }
            else
            {
                sb.AppendLine("\n⚠️ No file paths available in HTML5 D&D");
                sb.AppendLine("(Expected behavior in MAUI Blazor Hybrid)");
            }
            
            result1 = sb.ToString();
        }
        catch (Exception ex)
        {
            result1 = $"Error: {ex.Message}\n\n{ex.StackTrace}";
        }
        
        StateHasChanged();
        return Task.CompletedTask;
    }

    // 方式2: JavaScript Interop からの呼び出し
    [JSInvokable]
    public void OnJsFileDrop(string[] filePaths)
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine($"[{DateTime.Now:HH:mm:ss}] JS Drop detected!");
        sb.AppendLine($"Files count: {filePaths.Length}");
        
        if (filePaths.Length > 0)
        {
            sb.AppendLine("\nFile paths:");
            foreach (var path in filePaths)
            {
                sb.AppendLine($"  ✅ {path}");
            }
        }
        else
        {
            sb.AppendLine("\n⚠️ No file paths received");
        }
        
        result2 = sb.ToString();
        InvokeAsync(StateHasChanged);
    }

    // 方式3: FilePicker
    private async Task OpenFilePicker()
    {
        try
        {
            var options = new PickOptions
            {
                PickerTitle = "Select files to convert",
                FileTypes = new FilePickerFileType(new Dictionary<DevicePlatform, IEnumerable<string>>
                {
                    { DevicePlatform.WinUI, new[] { ".pdf", ".docx", ".xlsx", ".pptx", ".html", ".json", ".xml" } }
                })
            };
            
            var files = await FilePicker.Default.PickMultipleAsync(options);
            
            if (files != null && files.Any())
            {
                var sb = new System.Text.StringBuilder();
                sb.AppendLine($"[{DateTime.Now:HH:mm:ss}] Files selected!");
                sb.AppendLine($"Files count: {files.Count()}");
                sb.AppendLine("\nFile paths:");
                
                foreach (var file in files)
                {
                    sb.AppendLine($"  ✅ {file.FullPath}");
                }
                
                result3 = sb.ToString();
            }
            else
            {
                result3 = "No files selected";
            }
        }
        catch (Exception ex)
        {
            result3 = $"Error: {ex.Message}";
        }
        
        StateHasChanged();
    }

    public void Dispose()
    {
        MainPage.OnFilesDropped -= HandleMauiDrop;
        dotNetRef?.Dispose();
    }
}
